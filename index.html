<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="doc-title">Гид по Таразу</title>
    
    <script>
        // Fallback для локального использования, если Telegram Web App недоступен
        if (typeof window.Telegram === 'undefined') {
            window.Telegram = {
                WebApp: {
                    ready: function() {},
                    expand: function() {},
                    setHeaderColor: function() {},
                    setBackgroundColor: function() {},
                    onViewportChanged: { addListener: function() {} },
                    initData: ''
                }
            };
        }
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>


    <style>
        /* --- ОСНОВНЫЕ СТИЛИ --- */
        :root {
            --primary-sand: #D4A574;
            --primary-teal: #4A9B9F;
            --primary-terra: #C75B39;
            --light-bg: #FAFAFA;
            --dark-bg: #1A1A1A;
            --light-card: #FFFFFF;
            --dark-card: #2D2D2D;
            --light-text: #333333;
            --dark-text: #E8E8E8;
        }

        * { box-sizing: border-box; }

        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--light-bg);
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        body.dark-theme {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        /* --- КОНТЕЙНЕР ПРИЛОЖЕНИЯ --- */
        .app-container {
            height: 100vh;
            display: flex;
            position: relative;
        }

        /* Карта на весь экран */
        #map { 
            height: 100vh; 
            width: 100%; 
            z-index: 1;
            flex: 1;
        }

        /* --- БОКОВАЯ ПАНЕЛЬ --- */
        .sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 80px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 15px;
            gap: 15px;
            border-left: 1px solid rgba(212, 165, 116, 0.2);
            transition: all 0.3s ease;
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.05);
        }

        body.dark-theme .sidebar {
            background: rgba(45, 45, 45, 0.95);
            border-left: 1px solid rgba(74, 155, 159, 0.2);
        }

        /* --- ЛОГОТИП/ЗАГОЛОВОК --- */
        .sidebar-header {
            font-size: 24px;
            margin-bottom: 10px;
            text-align: center;
        }

        .sidebar-divider {
            width: 40px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212, 165, 116, 0.3), transparent);
            margin: 10px 0;
        }

        /* --- КНОПКИ ИНСТРУМЕНТОВ --- */
        .tool-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            justify-content: flex-start;
            margin-top: 15px;
        }

        .tool-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: linear-gradient(135deg, var(--primary-sand), var(--primary-teal));
            color: white;
            box-shadow: 0 4px 12px rgba(212, 165, 116, 0.25);
            font-weight: bold;
        }

        .tool-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(212, 165, 116, 0.35);
        }

        .tool-btn:active {
            transform: scale(0.92);
            animation: pulse 0.6s cubic-bezier(0.4, 0, 0.6, 1);
        }

        .tool-btn.search {
            background: linear-gradient(135deg, #FF8C42, #FFB366);
        }

        .tool-btn.language {
            background: linear-gradient(135deg, #4A9B9F, #2D7A7E);
        }



        .tool-btn.history {
            background: linear-gradient(135deg, #9B6BA8, #C89BC8);
        }

        .tool-btn.favorites {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .tool-btn.mapstyle {
            background: linear-gradient(135deg, #E67E22, #D35400);
        }

        body.dark-theme .tool-btn {
            background: linear-gradient(135deg, var(--primary-teal), var(--primary-sand));
            box-shadow: 0 4px 12px rgba(74, 155, 159, 0.25);
        }

        body.dark-theme .tool-btn:hover {
            box-shadow: 0 8px 20px rgba(74, 155, 159, 0.35);
        }

        /* Подсказка при наведении */
        .tool-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            right: 70px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 100;
        }

        .tool-btn:hover::after {
            opacity: 1;
            transform: translateX(0);
        }

        body.dark-theme .tool-btn::after {
            background: rgba(255, 255, 255, 0.9);
            color: #1A1A1A;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(212, 165, 116, 0.25);
            }
            50% {
                transform: scale(0.95);
                box-shadow: 0 2px 8px rgba(212, 165, 116, 0.15);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 12px rgba(212, 165, 116, 0.25);
            }
        }

        /* --- МОДАЛЬНОЕ ОКНО --- */
        #modal {
            position: fixed; 
            bottom: -100%; 
            left: 0; 
            right: 80px;
            height: 70vh;
            background: linear-gradient(180deg, #f5d89f 0%, #f9d88f 100%);
            border-radius: 20px 20px 0 0; 
            z-index: 1000;
            transition: bottom 0.3s cubic-bezier(0.1, 0.7, 1.0, 0.1);
            display: flex; 
            flex-direction: column;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.15), inset 0 1px 2px rgba(255,255,255,0.5);
            overflow: hidden;
        }

        /* Винтажная текстура фона */
        #modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: none;
            pointer-events: none;
            z-index: 0;
        }

        body.dark-theme #modal {
            background: linear-gradient(180deg, #3a2f2a 0%, #2d2420 100%);
            color: #e8c499;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.4), inset 0 1px 2px rgba(255,255,255,0.1);
        }

        #modal.active { bottom: 0; }

        .modal-header {
            padding: 15px 20px; 
            border-bottom: 2px solid rgba(199, 91, 57, 0.2); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-shrink: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, transparent 100%);
            position: relative;
            z-index: 1;
        }

        body.dark-theme .modal-header {
            background: linear-gradient(180deg, rgba(58, 47, 42, 0.5) 0%, rgba(45, 36, 32, 0.3) 100%);
            border-bottom: 2px solid rgba(199, 91, 57, 0.3);
        }

        .modal-header h2 { 
            margin: 0; 
            font-size: 22px; 
            font-weight: 700;
            color: #5a3a2a;
            flex: 1;
            text-shadow: 0 1px 2px rgba(255,255,255,0.3);
            letter-spacing: -0.3px;
        }

        body.dark-theme .modal-header h2 {
            color: #e8c499;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
        }

        .modal-header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .modal-fav-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }

        .modal-fav-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
        }

        .modal-fav-btn:active {
            transform: scale(0.95);
        }

        /* AR КНОПКА В ЗАГОЛОВКЕ */
        .modal-ar-btn {
            background: linear-gradient(135deg, #FF8C42, #FFB366);
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(199, 91, 57, 0.3);
            margin-right: 5px;
        }

        .modal-ar-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(199, 91, 57, 0.5);
        }

        .modal-ar-btn:active {
            transform: scale(0.95);
        }

        /* 3D QR КНОПКА В ЗАГОЛОВКЕ */
        .modal-3d-btn {
            background: linear-gradient(135deg, #00BCD4, #0097A7);
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 188, 212, 0.4);
            margin-right: 5px;
        }

        .modal-3d-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0, 188, 212, 0.6);
            background: linear-gradient(135deg, #00D4E8, #00B8D4);
        }

        .modal-3d-btn:active {
            transform: scale(0.95);
        }

        .modal-3d-btn-2 {
            background: linear-gradient(135deg, #00FF88, #00CC66);
            border: none;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            font-size: 14px;
            font-weight: bold;
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.4);
            margin-right: 5px;
        }

        .modal-3d-btn-2:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(0, 255, 136, 0.6);
            background: linear-gradient(135deg, #00FF99, #00DD77);
        }

        .modal-3d-btn-2:active {
            transform: scale(0.95);
        }

        .close-btn { 
            font-size: 24px; 
            color: #999; 
            cursor: pointer; 
            padding: 5px 10px;
            transition: all 0.3s;
            border: none;
            background: none;
        }

        .close-btn:hover {
            color: var(--primary-terra);
            transform: scale(1.2);
        }

        /* Контейнер прокрутки для видео и описания */
        .modal-scroll-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .modal-scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .modal-scroll-container::-webkit-scrollbar-track {
            background: rgba(212, 165, 116, 0.08);
        }

        .modal-scroll-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(199, 91, 57, 0.4), rgba(199, 91, 57, 0.2));
            border-radius: 4px;
        }

        .modal-scroll-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(199, 91, 57, 0.6), rgba(199, 91, 57, 0.4));
        }

        .video-container { 
            width: 100%; 
            height: 200px; 
            background: #000; 
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3), 0 2px 8px rgba(0,0,0,0.1);
        }

        #video-player { 
            width: 100%; 
            height: 250px; 
            object-fit: cover; 
        }

        video { 
            width: 100%; 
            height: 250px; 
            object-fit: cover; 
        }

        /* Информация о месте - ЗИГЗАГ МАКЕТ */
        .place-info {
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        /* Карточка информации */
        .info-row {
            display: flex;
            gap: 18px;
            align-items: flex-start;
        }

        /* Чередование: четные справа, нечетные слева */
        .info-row:nth-child(even) {
            flex-direction: row-reverse;
        }

        .place-image {
            width: 110px;
            height: 110px;
            min-width: 110px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15), inset 0 1px 2px rgba(255,255,255,0.3);
            border: 2px solid rgba(255, 255, 255, 0.4);
        }

        .place-text-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .place-title {
            font-size: 15px;
            font-weight: 700;
            color: #5a3a2a;
            margin: 0;
            text-shadow: 0 1px 1px rgba(255,255,255,0.2);
        }

        body.dark-theme .place-title {
            color: #e8c499;
        }

        .place-description {
            font-size: 13px;
            line-height: 1.5;
            color: #5a3a2a;
            margin: 0;
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
        }

        body.dark-theme .place-description {
            color: #c9b8a8;
            text-shadow: 0 1px 1px rgba(255,255,255,0.2);
        }

        /* Анимации для АИ чата */
        @keyframes glow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.15); }
        }

        @keyframes aiPulse {
            0% {
                background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
                box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 -2px 8px rgba(74, 155, 159, 0.15);
            }
            50% {
                background: linear-gradient(180deg, rgba(74, 155, 159, 0.25) 0%, rgba(74, 155, 159, 0.15) 100%);
                box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 -2px 16px rgba(74, 155, 159, 0.35);
            }
            100% {
                background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
                box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 -2px 8px rgba(74, 155, 159, 0.15);
            }
        }

        /* Секция чата - РАСШИРЯЕМАЯ */
        .chat-section {
            display: flex;
            flex-direction: column;
            max-height: 220px;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
            border-top: 2px solid rgba(74, 155, 159, 0.4);
            flex-shrink: 0;
            backdrop-filter: blur(8px);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.3), 0 -2px 8px rgba(74, 155, 159, 0.15);
            transition: max-height 0.3s ease;
            position: relative;
            animation: aiPulse 4s ease-in-out 3;
        }

        /* Светящаяся линия сверху чата */
        .chat-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(74, 155, 159, 0.6), transparent);
            animation: glow 2s ease-in-out infinite;
            pointer-events: none;
        }

        .chat-section.expanded {
            max-height: 350px;
        }

        body.dark-theme .chat-section {
            background: linear-gradient(180deg, rgba(74, 155, 159, 0.2) 0%, rgba(74, 155, 159, 0.1) 100%);
            border-top: 2px solid rgba(74, 155, 159, 0.5);
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.15), 0 -2px 12px rgba(74, 155, 159, 0.25);
        }

        .chat-label {
            padding: 10px 14px;
            font-size: 10px;
            font-weight: 700;
            color: #c75b39;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 1px rgba(255,255,255,0.3);
            border-bottom: 1px solid rgba(199, 91, 57, 0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        /* Иконка ИИ помощника */
        .chat-label::before {
            content: '🤖';
            font-size: 14px;
            animation: sparkle 2s ease-in-out infinite;
            display: inline-block;
            filter: drop-shadow(0 0 4px rgba(74, 155, 159, 0.5));
        }

        /* Бейджик AI */
        .chat-label::after {
            content: 'AI';
            font-size: 8px;
            font-weight: 900;
            color: white;
            background: linear-gradient(135deg, #4A9B9F, #2D7A7E);
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 4px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 6px rgba(74, 155, 159, 0.4);
        }

        body.dark-theme .chat-label {
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(255,255,255,0.15);
            border-bottom: 1px solid rgba(74, 155, 159, 0.15);
        }

        body.dark-theme .chat-label::before {
            filter: drop-shadow(0 0 6px rgba(78, 205, 196, 0.6));
        }

        body.dark-theme .chat-label::after {
            background: linear-gradient(135deg, #6ab3b7, #4ecdd4);
            box-shadow: 0 2px 8px rgba(74, 155, 159, 0.6);
        }

        .chat-history {
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 10px 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
        }

        .chat-history::-webkit-scrollbar {
            width: 5px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: rgba(199, 91, 57, 0.25);
            border-radius: 3px;
        }

        .chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(199, 91, 57, 0.4);
        }

        .chat-history::-webkit-scrollbar-thumb:hover {
            background: rgba(199, 91, 57, 0.5);
        }

        .message {
            max-width: 85%; 
            padding: 8px 12px; 
            border-radius: 10px; 
            font-size: 13px; 
            line-height: 1.4; 
            position: relative; 
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.ai {
            align-self: flex-start; 
            background: rgba(255, 255, 255, 0.35); 
            color: #4a3530; 
            border: 1px solid rgba(255, 255, 255, 0.5); 
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        body.dark-theme .message.ai {
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
            border: 1px solid rgba(74, 155, 159, 0.25);
        }

        .message.user {
            align-self: flex-end; 
            background: linear-gradient(135deg, #c75b39, #b84830);
            color: white; 
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(199, 91, 57, 0.2);
        }

        .message.loading {
            align-self: flex-start; 
            color: #888; 
            font-style: italic; 
            font-size: 12px; 
            padding-left: 8px; 
            background: none; 
            border: none;
        }

        .input-area {
            padding: 10px 12px; 
            background: transparent;
            border-top: 1px solid rgba(255, 255, 255, 0.15); 
            display: flex; 
            gap: 8px;
            flex-shrink: 0;
        }

        body.dark-theme .input-area {
            background: rgba(30, 30, 30, 0.95);
            border-top: 1px solid rgba(74, 155, 159, 0.2);
        }

        .input-area input {
            flex-grow: 1; 
            padding: 9px 13px; 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 18px; 
            font-size: 13px; 
            outline: none; 
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.45);
            color: #5a3a2a;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.03);
        }

        .input-area input::placeholder {
            color: rgba(90, 58, 42, 0.5);
        }

        body.dark-theme .input-area input {
            background: rgba(50, 50, 50, 0.95);
            color: #ffffff;
            border: 1px solid rgba(74, 155, 159, 0.4);
        }

        body.dark-theme .input-area input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .input-area input::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }

        .input-area input:focus { 
            border-color: var(--primary-teal);
            box-shadow: 0 0 8px rgba(74, 155, 159, 0.2);
        }

        .input-area button {
            width: 38px; 
            height: 38px; 
            border: none; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #c75b39, #b84830);
            color: white; 
            font-size: 16px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(199, 91, 57, 0.25);
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .input-area button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(199, 91, 57, 0.4);
            background: linear-gradient(135deg, #d66b47, #c95a38);
        }

        .input-area button:active { 
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(199, 91, 57, 0.3);
        }

        /* --- МОДАЛЬНЫЕ ОКНА ФУНКЦИЙ --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(180deg, var(--light-card), rgba(255, 255, 255, 0.95));
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.6);
            animation: slideUp 0.3s ease;
            border: 1px solid rgba(212, 165, 116, 0.2);
        }

        body.dark-theme .modal-content {
            background: linear-gradient(180deg, var(--dark-card), rgba(45, 45, 45, 0.98));
            border-color: rgba(74, 155, 159, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            background: linear-gradient(135deg, var(--primary-sand), var(--primary-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 0;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(212, 165, 116, 0.3);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-teal);
            box-shadow: 0 0 10px rgba(74, 155, 159, 0.2);
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .search-result-item {
            padding: 16px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.08), rgba(74, 155, 159, 0.08));
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(212, 165, 116, 0.2);
            display: flex;
            gap: 16px;
            align-items: center;
            overflow: hidden;
            min-height: 120px;
        }

        .search-result-image {
            width: 100px;
            height: 100px;
            min-width: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid rgba(212, 165, 116, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .search-result-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .search-result-text strong {
            color: var(--primary-terra);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .search-result-text small {
            color: #999;
            font-size: 11px;
        }

        .search-result-btn {
            background: linear-gradient(135deg, var(--primary-sand), var(--primary-terra));
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            margin-left: auto;
            align-self: center;
            box-shadow: 0 4px 10px rgba(199, 91, 57, 0.25);
        }

        .search-result-btn:hover {
            background: linear-gradient(135deg, var(--primary-teal), #2D7A7E);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(74, 155, 159, 0.35);
        }

        #search-results {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 0;
        }

        #search-results::-webkit-scrollbar {
            width: 6px;
        }

        #search-results::-webkit-scrollbar-track {
            background: transparent;
        }

        #search-results::-webkit-scrollbar-thumb {
            background: rgba(212, 165, 116, 0.5);
            border-radius: 3px;
        }

        #search-results::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 165, 116, 0.8);
        }

        body.dark-theme .search-result-item {
            background: linear-gradient(135deg, rgba(74, 155, 159, 0.15), rgba(74, 155, 159, 0.08));
            border-color: rgba(74, 155, 159, 0.3);
        }

        body.dark-theme .search-result-text strong {
            color: #e8c499;
        }

        .search-result-item:hover {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.15), rgba(74, 155, 159, 0.15));
            border-color: var(--primary-sand);
            transform: translateX(5px);
            box-shadow: 0 4px 16px rgba(212, 165, 116, 0.2);
        }

        body.dark-theme .search-result-item:hover {
            background: linear-gradient(135deg, rgba(74, 155, 159, 0.25), rgba(74, 155, 159, 0.15));
            border-color: var(--primary-teal);
            box-shadow: 0 4px 16px rgba(74, 155, 159, 0.3);
        }

        /* Переключатель языка */
        .language-select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(212, 165, 116, 0.3);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            cursor: pointer;
            background: var(--light-card);
            color: var(--light-text);
        }

        body.dark-theme .language-select {
            background: #1a1a1a;
            color: #ffffff;
            border-color: rgba(74, 155, 159, 0.3);
        }

        /* Стили для опций выпадающего списка в темном режиме */
        body.dark-theme .language-select option {
            background: #2d2d2d;
            color: #ffffff;
        }

        /* Текущий язык */
        .current-lang-display {
            font-size: 12px;
            color: #999;
            margin-top: 15px;
        }

        body.dark-theme .current-lang-display {
            color: #b8a08a;
        }

        /* Переключатель темы */
        .theme-toggle {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .theme-option {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(212, 165, 116, 0.3);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: var(--light-card);
            color: var(--light-text);
        }

        .theme-option.active {
            border-color: var(--primary-teal);
            background: rgba(74, 155, 159, 0.1);
        }

        body.dark-theme .theme-option {
            border-color: rgba(74, 155, 159, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        .favorites-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .favorite-item {
            padding: 14px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.12), rgba(74, 155, 159, 0.08));
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid rgba(212, 165, 116, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .favorite-item:hover {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.2), rgba(74, 155, 159, 0.15));
            transform: translateX(5px);
            border-color: var(--primary-sand);
            box-shadow: 0 6px 16px rgba(212, 165, 116, 0.2);
        }

        body.dark-theme .favorite-item {
            background: linear-gradient(135deg, rgba(74, 155, 159, 0.15), rgba(74, 155, 159, 0.08));
            border-color: rgba(74, 155, 159, 0.3);
        }

        body.dark-theme .favorite-item:hover {
            background: linear-gradient(135deg, rgba(74, 155, 159, 0.25), rgba(74, 155, 159, 0.15));
            border-color: var(--primary-teal);
            box-shadow: 0 6px 16px rgba(74, 155, 159, 0.3);
        }

        .remove-favorite {
            background: var(--primary-terra);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .remove-favorite:hover {
            transform: scale(1.1);
            background: #A63B20;
        }

        /* --- АДАПТИВНОСТЬ --- */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                right: auto;
                bottom: 0;
                height: auto;
                width: 100%;
                flex-direction: row;
                border-left: none;
                border-top: 1px solid rgba(212, 165, 116, 0.2);
                padding: 10px 15px;
                gap: 8px;
                justify-content: center;
                overflow-x: auto;
            }

            .sidebar-header {
                display: none;
            }

            .sidebar-divider {
                display: none;
            }

            .tool-buttons {
                flex-direction: row;
                margin-top: 0;
                justify-content: center;
            }

            .tool-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .tool-btn::after {
                display: none;
            }

            #modal {
                right: 0;
                height: 80vh;
            }

            .modal-scroll-container {
                max-height: 40vh;
            }

            .chat-section {
                max-height: 180px;
            }

            .chat-section.expanded {
                max-height: 280px;
            }

            .video-container {
                height: 120px;
            }

            .place-image {
                width: 90px;
                height: 90px;
            }

            .place-description {
                font-size: 13px;
            }

            .message {
                font-size: 12px;
            }

            .modal-header h2 {
                font-size: 16px;
            }
        }

        @media (max-height: 600px) {
            #modal {
                height: 90vh;
            }

            .video-container {
                height: 100px;
            }

            .modal-scroll-container {
                max-height: 30vh;
            }

            .chat-section {
                height: 180px;
            }

            .place-image {
                height: 120px;
            }
        }

        /* --- СТИЛИ КНОПОК ВЫБОРА СТИЛЯ КАРТЫ --- */
        .mapstyle-btn {
            padding: 12px 16px;
            border: 2px solid var(--primary-sand);
            background: white;
            color: var(--light-text);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        body.dark-theme .mapstyle-btn {
            background: var(--dark-card);
            color: var(--dark-text);
            border-color: var(--primary-teal);
        }

        .mapstyle-btn:hover {
            background: var(--primary-sand);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 165, 116, 0.3);
        }

        body.dark-theme .mapstyle-btn:hover {
            background: var(--primary-teal);
            border-color: var(--primary-teal);
        }

        .mapstyle-btn.active {
            background: var(--primary-sand);
            color: white;
            border-color: var(--primary-terra);
            box-shadow: 0 4px 12px rgba(212, 165, 116, 0.4);
        }

        body.dark-theme .mapstyle-btn.active {
            background: var(--primary-teal);
            border-color: var(--primary-teal);
        }

        /* --- СТИЛИ МАРШРУТИЗАЦИИ --- */
        .routing-control {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 320px;
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.95) 0%, rgba(212, 165, 116, 0.85) 100%);
            border-radius: 16px;
            padding: 20px;
            z-index: 500;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            flex-direction: column;
            gap: 12px;
            animation: slideInDown 0.4s cubic-bezier(0.1, 0.7, 1, 1);
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .routing-control.active {
            display: flex;
        }

        body.dark-theme .routing-control {
            background: linear-gradient(135deg, rgba(45, 45, 45, 0.95) 0%, rgba(45, 45, 45, 0.85) 100%);
            border: 1px solid rgba(74, 155, 159, 0.2);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .routing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .routing-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #5a3a2a;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        body.dark-theme .routing-header h3 {
            color: #e8c499;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }

        .routing-close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: rgba(90, 58, 42, 0.6);
            transition: all 0.2s;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .routing-close-btn:hover {
            color: rgba(90, 58, 42, 1);
            transform: scale(1.1);
        }

        body.dark-theme .routing-close-btn {
            color: rgba(232, 196, 153, 0.6);
        }

        body.dark-theme .routing-close-btn:hover {
            color: rgba(232, 196, 153, 1);
        }

        .routing-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .routing-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .routing-input-group label {
            font-size: 18px;
            min-width: 24px;
            flex-shrink: 0;
        }

        .routing-input-group input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.85);
            color: #5a3a2a;
            transition: all 0.2s;
            font-family: inherit;
        }

        .routing-input-group input::placeholder {
            color: rgba(90, 58, 42, 0.5);
        }

        .routing-input-group input:focus {
            outline: none;
            background: white;
            box-shadow: 0 0 0 2px rgba(74, 155, 159, 0.3);
            border-color: rgba(74, 155, 159, 0.4);
        }

        body.dark-theme .routing-input-group input {
            background: rgba(50, 50, 50, 0.9);
            color: #e8c499;
            border-color: rgba(74, 155, 159, 0.2);
        }

        body.dark-theme .routing-input-group input::placeholder {
            color: rgba(232, 196, 153, 0.5);
        }

        body.dark-theme .routing-input-group input:focus {
            background: rgba(60, 60, 60, 0.95);
            box-shadow: 0 0 0 2px rgba(74, 155, 159, 0.4);
        }

        .routing-map-btn {
            padding: 8px 10px;
            background: linear-gradient(135deg, #74b9ff, #5195d2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(74, 155, 159, 0.2);
        }

        .routing-map-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 10px rgba(74, 155, 159, 0.4);
            background: linear-gradient(135deg, #5195d2, #3978b8);
        }

        .routing-map-btn:active {
            transform: scale(0.95);
        }

        .routing-map-btn.active {
            background: linear-gradient(135deg, #FF8C42, #FFB366);
            box-shadow: 0 4px 12px rgba(199, 91, 57, 0.4);
        }

        body.dark-theme .routing-map-btn {
            background: linear-gradient(135deg, #4A9B9F, #357a82);
            box-shadow: 0 2px 6px rgba(74, 155, 159, 0.3);
        }

        body.dark-theme .routing-map-btn:hover {
            background: linear-gradient(135deg, #357a82, #266168);
        }

        body.dark-theme .routing-map-btn.active {
            background: linear-gradient(135deg, #FF8C42, #FFB366);
        }

        .routing-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .routing-btn {
            flex: 1;
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(199, 91, 57, 0.2);
        }

        /* === СТИЛИ ДЛЯ ВЫБОРА СПОСОБА ПЕРЕДВИЖЕНИЯ === */
        .transport-modes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        body.dark-theme .transport-modes {
            background: rgba(74, 155, 159, 0.1);
        }

        .transport-mode-btn {
            padding: 8px 6px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.6);
            color: #5a3a2a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .transport-mode-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .transport-mode-btn.active {
            background: linear-gradient(135deg, #FF8C42, #FFB366);
            color: white;
            border-color: #FFB366;
            box-shadow: 0 4px 12px rgba(199, 91, 57, 0.3);
        }

        body.dark-theme .transport-mode-btn {
            background: rgba(60, 60, 60, 0.9);
            color: #e8c499;
            border-color: rgba(74, 155, 159, 0.3);
        }

        body.dark-theme .transport-mode-btn.active {
            background: linear-gradient(135deg, #FF8C42, #FFB366);
            border-color: #FFB366;
        }

        .transport-mode-icon {
            font-size: 18px;
        }

        /* === СТИЛИ ДЛЯ ВРЕМЕНИ В ПУТИ === */
        .routing-time-container {
            background: rgba(74, 155, 159, 0.15);
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .routing-time-container.show {
            display: block;
        }

        body.dark-theme .routing-time-container {
            background: rgba(74, 155, 159, 0.1);
        }

        .time-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
            color: #5a3a2a;
            border-bottom: 1px solid rgba(212, 165, 116, 0.2);
            transition: all 0.2s ease;
        }

        .time-row:hover {
            background: rgba(212, 165, 116, 0.08);
            border-radius: 4px;
            padding: 8px 6px;
            margin: 0 -6px;
        }

        body.dark-theme .time-row {
            color: #e8c499;
        }

        body.dark-theme .time-row:hover {
            background: rgba(74, 155, 159, 0.1);
        }

        .time-row:last-child {
            border-bottom: none;
        }

        .time-mode {
            font-weight: 600;
            flex: 1;
        }

        .time-value {
            background: rgba(74, 155, 159, 0.2);
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 700;
            margin-right: 6px;
        }

        body.dark-theme .time-value {
            background: rgba(74, 155, 159, 0.3);
        }

        /* Выделение для быстрейшего способа */
        .time-row:first-child {
            background: rgba(76, 175, 80, 0.08);
            padding: 8px 6px;
            margin: 0 -6px;
            border-radius: 4px;
        }

        .time-row:first-child .time-mode {
            color: #2E7D32;
        }

        body.dark-theme .time-row:first-child .time-mode {
            color: #66BB6A;
        }

        body.dark-theme .time-row:first-child {
            background: rgba(102, 187, 106, 0.1);
        }

        /* Стиль для одиночной информации о способе передвижения */
        .time-row.single-mode {
            background: rgba(76, 175, 80, 0.1) !important;
            padding: 12px 8px !important;
            margin: 0 -6px !important;
            border-radius: 6px !important;
            border: none !important;
        }

        .time-row.single-mode .time-mode {
            color: #2E7D32 !important;
            font-size: 15px !important;
        }

        body.dark-theme .time-row.single-mode {
            background: rgba(102, 187, 106, 0.15) !important;
        }

        body.dark-theme .time-row.single-mode .time-mode {
            color: #66BB6A !important;
        }

        /* === АЛЬТЕРНАТИВНЫЕ МАРШРУТЫ === */
        .routes-container {
            display: none;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
        }

        .routes-container.show {
            display: block;
        }

        body.dark-theme .routes-container {
            background: rgba(74, 155, 159, 0.1);
        }

        .route-option {
            padding: 8px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #5a3a2a;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        body.dark-theme .route-option {
            background: rgba(60, 60, 60, 0.9);
            color: #e8c499;
        }

        .route-option:hover {
            background: white;
            border-color: #FFB366;
            transform: translateX(3px);
        }

        .route-option.selected {
            background: linear-gradient(135deg, #FF8C42, #FFB366);
            color: white;
            border-color: #FFB366;
        }

        .routing-btn-search {
            background: linear-gradient(135deg, #FF8C42, #FFB366);
            color: white;
        }

        .routing-btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(199, 91, 57, 0.3);
        }

        .routing-btn-search:active {
            transform: scale(0.95);
        }

        .routing-btn-clear {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            color: white;
        }

        .routing-btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(199, 91, 57, 0.3);
        }

        .routing-btn-clear:active {
            transform: scale(0.95);
        }

        body.dark-theme .routing-btn {
            box-shadow: 0 2px 8px rgba(74, 155, 159, 0.2);
        }

        .routing-info {
            font-size: 12px;
            color: rgba(90, 58, 42, 0.7);
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            display: none;
        }

        body.dark-theme .routing-info {
            color: rgba(232, 196, 153, 0.7);
            background: rgba(74, 155, 159, 0.1);
        }

        .routing-info.show {
            display: block;
        }

        /* Стили для Leaflet Routing Machine */
        .leaflet-routing-container {
            background: linear-gradient(135deg, rgba(212, 165, 116, 0.95) 0%, rgba(212, 165, 116, 0.85) 100%) !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        body.dark-theme .leaflet-routing-container {
            background: linear-gradient(135deg, rgba(45, 45, 45, 0.95) 0%, rgba(45, 45, 45, 0.85) 100%) !important;
            border: 1px solid rgba(74, 155, 159, 0.2) !important;
        }

        .leaflet-routing-alt {
            color: #5a3a2a !important;
        }

        body.dark-theme .leaflet-routing-alt {
            color: #e8c499 !important;
        }

        .leaflet-routing-error {
            color: #d32f2f !important;
            font-weight: 600;
        }

        /* Стили для маркеров выбора точек */
        .leaflet-circle-marker {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.8;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.8;
            }
        }
        /* --- СТИЛИ ДЛЯ ИИ КНОПКИ И ЧАТА --- */

/* 1. Плавающая кнопка (Floating Action Button) */
.ai-fab-btn {
    position: fixed;
    bottom: 30px;
    right: 10px; /* Выравнивание по центру боковой панели (80px - 60px) / 2 = 10px */
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6C5CE7, #a29bfe); /* Фиолетовый градиент */
    color: white;
    border: 3px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 4px 15px rgba(108, 92, 231, 0.5);
    font-size: 30px;
    cursor: pointer;
    z-index: 2000; /* Очень высокий z-index, чтобы быть поверх всего */
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s, box-shadow 0.2s;
    animation: ai-pulse 3s infinite;
}

.ai-fab-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(108, 92, 231, 0.7);
}

.ai-fab-btn:active {
    transform: scale(0.95);
}

/* Анимация пульсации */
@keyframes ai-pulse {
    0% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(108, 92, 231, 0); }
    100% { box-shadow: 0 0 0 0 rgba(108, 92, 231, 0); }
}

/* Подсказка для кнопки */
.ai-hint-bubble {
    position: fixed;
    bottom: 100px;
    right: 10px;
    background: linear-gradient(135deg, #6C5CE7, #a29bfe);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease-in-out;
    box-shadow: 0 4px 15px rgba(108, 92, 231, 0.5);
    z-index: 1999;
}

.ai-hint-bubble::after {
    content: '';
    position: absolute;
    bottom: -8px;
    right: 20px;
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid #6C5CE7;
}

.ai-hint-bubble.show {
    opacity: 1;
    animation: hint-float 0.4s ease-out;
}

@keyframes hint-float {
    0% {
        transform: translateY(20px) scale(0.8);
        opacity: 0;
    }
    100% {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

/* 2. Модальное окно глобального чата */
#global-ai-modal {
    position: fixed;
    bottom: -100%;
    left: 0;
    right: 0; /* На весь экран по ширине или ограничьте right: 80px как в других окнах */
    height: 75vh;
    background: linear-gradient(180deg, #f0f4ff 0%, #ffffff 100%);
    border-radius: 20px 20px 0 0;
    z-index: 2001; /* Поверх кнопки */
    transition: bottom 0.3s cubic-bezier(0.1, 0.7, 1.0, 0.1);
    display: flex;
    flex-direction: column;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
}

/* Темная тема для глобального чата */
body.dark-theme #global-ai-modal {
    background: linear-gradient(180deg, #3a2f2a 0%, #2d2420 100%);
    box-shadow: 0 -10px 30px rgba(0,0,0,0.4);
}

#global-ai-modal.active {
    bottom: 0;
}

/* На мобильных поднимаем кнопку чуть выше, если мешает интерфейсу */
@media (max-width: 768px) {
    .ai-fab-btn {
        bottom: 90px; /* Чтобы не перекрывать нижнюю панель */
        right: 15px;
    }
}

/* AR МОДАЛЬНОЕ ОКНО */
.ar-modal-container {
    width: 100%;
    height: 100vh;
    max-width: 100%;
    border-radius: 15px;
    overflow: hidden;
    background: black;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.ar-modal-header {
    background: linear-gradient(135deg, var(--primary-sand), var(--primary-teal));
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.ar-modal-header h2 {
    color: white;
    -webkit-text-fill-color: white;
    background: none;
    margin: 0;
    font-size: 20px;
}

.ar-modal-header .close-btn {
    background: rgba(255, 255, 255, 0.2);
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s;
}

.ar-modal-header .close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* AR КНОПКА */
.ar-button {
    background: linear-gradient(135deg, #FF8C42, #FFB366);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(199, 91, 57, 0.3);
}

.ar-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(199, 91, 57, 0.4);
}

.ar-button:active {
    transform: translateY(0);
}

body.dark-theme .ar-button {
    background: linear-gradient(135deg, #FF8C42, #FFB366);
}

/* QR МОДАЛЬНОЕ ОКНО */
.qr-modal-container {
    width: 100%;
    height: 100vh;
    max-width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.qr-modal-content {
    background: rgba(255, 255, 255, 0.98);
    border-radius: 20px;
    padding: 40px;
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 20px 80px rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    animation: zoomIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
}

.qr-image {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    animation: fadeInScale 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes zoomIn {
    from {
        transform: scale(0.3);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes fadeInScale {
    from {
        transform: scale(0.8);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

body.dark-theme .qr-modal-content {
    background: rgba(45, 45, 45, 0.98);
}

    </style>

</head>
<body>
    <div class="app-container">
        <div id="map"></div>

        <!-- ПАНЕЛЬ МАРШРУТИЗАЦИИ -->
        <div class="routing-control" id="routing-control">
            <div class="routing-header">
                <h3>🛣️ Маршрут</h3>
                <button class="routing-close-btn" onclick="closeRoutingPanel()">✕</button>
            </div>
            <div class="routing-inputs">
                <div class="routing-input-group">
                    <label>📍</label>
                    <input type="text" id="start-input" class="routing-start-input" placeholder="Начало маршрута">
                    <button class="routing-map-btn" id="start-map-btn" onclick="selectPointOnMap('start')" title="Выбрать на карте">🗺️</button>
                </div>
                <div class="routing-input-group">
                    <label>🎯</label>
                    <input type="text" id="end-input" class="routing-end-input" placeholder="Конец маршрута">
                    <button class="routing-map-btn" id="end-map-btn" onclick="selectPointOnMap('end')" title="Выбрать на карте">🗺️</button>
                </div>
            </div>

            <!-- ВЫБОР СПОСОБА ПЕРЕДВИЖЕНИЯ -->
            <div class="transport-modes">
                <button class="transport-mode-btn active" data-mode="car" onclick="selectTransportMode('car')">
                    <span class="transport-mode-icon">🚗</span>
                    <span>Машина</span>
                </button>
                <button class="transport-mode-btn" data-mode="foot" onclick="selectTransportMode('foot')">
                    <span class="transport-mode-icon">🚶</span>
                    <span>Пешком</span>
                </button>
                <button class="transport-mode-btn" data-mode="bike" onclick="selectTransportMode('bike')">
                    <span class="transport-mode-icon">🚴</span>
                    <span>Велик</span>
                </button>
                <button class="transport-mode-btn" data-mode="bus" onclick="selectTransportMode('bus')">
                    <span class="transport-mode-icon">🚌</span>
                    <span>Автобус</span>
                </button>
            </div>

            <!-- ВРЕМЯ В ПУТИ ДЛЯ РАЗНЫХ СПОСОБОВ -->
            <div class="routing-time-container" id="routing-time-container">
                <div style="font-weight: 700; margin-bottom: 6px; font-size: 12px;">⏱️ Время в пути:</div>
                <div id="time-rows-container"></div>
            </div>

            <!-- АЛЬТЕРНАТИВНЫЕ МАРШРУТЫ -->
            <div class="routes-container" id="routes-container">
                <div style="font-weight: 700; margin-bottom: 6px; font-size: 12px;">🛣️ Альтернативные маршруты:</div>
                <div id="routes-list"></div>
            </div>
            <div class="routing-buttons">
                <button class="routing-btn routing-btn-search" onclick="createRoute()">Найти маршрут</button>
                <button class="routing-btn routing-btn-clear" onclick="clearRoute()">Очистить</button>
            </div>
            <div class="routing-info" id="routing-info"></div>
        </div>

        <!-- БОКОВАЯ ПАНЕЛЬ -->
        <div class="sidebar">
            <div class="sidebar-header">🗺️</div>
            <div class="sidebar-divider"></div>
            
            <div class="tool-buttons">
                <button class="tool-btn search" data-tooltip="" onclick="openSearch()">🔍</button>
                <button class="tool-btn language" data-tooltip="" onclick="openLanguage()">🌐</button>
                <button class="tool-btn history" data-tooltip="" onclick="openHistory()">🕑</button>
                <button class="tool-btn favorites" data-tooltip="" onclick="openFavorites()">⭐</button>
                <button class="tool-btn" style="background: linear-gradient(135deg, #52B788, #2D6A4F);" data-tooltip="Маршрут" onclick="toggleRoutingPanel()">🛣️</button>
                <button class="tool-btn mapstyle" data-tooltip="" onclick="openMapStyle()">🎨</button>
            </div>
        </div>

        <!-- ОСНОВНОЙ МОДАЛЬНЫЙ ОКНА -->
        <div id="modal">
            <div class="modal-header">
                <h2 id="place-title"></h2>
                <div class="modal-header-buttons">
                    <button class="modal-ar-btn" id="modal-ar-btn" onclick="openARModal()" style="display: none;">🔍</button>
                    <button class="modal-3d-btn" id="modal-3d-btn" onclick="openQRModal()" style="display: none;">3D</button>
                    <button class="modal-3d-btn-2" id="modal-3d-btn-2" onclick="openQRModal2()" style="display: none;">3D</button>
                    <button class="modal-fav-btn" id="modal-fav-btn" onclick="addToFavoritesFromModal()">⭐</button>
                    <span class="close-btn" onclick="closeModal()">✕</span>
                </div>
            </div>
            
            <div class="modal-scroll-container">
                
                <div class="video-container">
                    <video id="video-player" controls playsinline></video>
                </div>

                <div class="place-info" id="place-info">
                    <!-- Зигзаг карточки будут вставлены здесь JavaScript -->
                </div>
            </div>

            <div class="chat-section">
                <div class="chat-label" id="chat-label">💬</div>
                <div id="chat-history" class="chat-history">
                    <div class="message ai" id="chat-welcome"></div>
                </div>

                <div class="input-area">
                    <input type="text" id="user-input" placeholder="" autocomplete="off">
                    <button onclick="sendMessage()">➤</button>
                </div>
            </div>
        </div>

        <!-- МОДАЛЬНОЕ ОКНО ПОИСКА -->
        <div id="search-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="search-modal-title">🔍</h2>
                <input type="text" id="search-input" class="search-input" placeholder="">
                <div id="search-results" class="search-results"></div>
            </div>
        </div>

        <!-- МОДАЛЬНОЕ ОКНО ЯЗЫКА -->
        <div id="language-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="language-modal-title">🌐</h2>
                <select id="language-select" class="language-select" onchange="changeLanguage()">
                    <option value="ru" selected id="lang-option-ru">Русский (РУ)</option>
                    <option value="kk" id="lang-option-kk">Қазақша (KK)</option>
                    <option value="en" id="lang-option-en">English (EN)</option>
                </select>
                <p class="current-lang-display" id="current-lang-container"><strong id="current-lang"></strong></p>
            </div>
        </div>

        <!-- МОДАЛЬНОЕ ОКНО ИСТОРИИ -->
        <div id="history-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="history-modal-title">🕑</h2>
                <div id="history-list" style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto;">
                    <p id="history-empty" style="color: #999; text-align: center;"></p>
                </div>
            </div>
        </div>

        <!-- МОДАЛЬНОЕ ОКНО ИЗБРАННОГО -->
        <div id="favorites-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="favorites-modal-title">⭐</h2>
                <div id="favorites-list" class="favorites-list">
                    <p id="favorites-empty" style="color: #999; text-align: center;"></p>
                </div>
            </div>
        </div>

        <!-- МОДАЛЬНОЕ ОКНО СТИЛЯ КАРТЫ -->
        <div id="mapstyle-modal" class="modal-overlay">
            <div class="modal-content">
                <h2 id="mapstyle-modal-title">🎨</h2>
                <div id="mapstyle-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="mapstyle-btn" data-style="light" onclick="changeMapStyle('light')" id="mapstyle-light-btn">Светлый режим</button>
                    <button class="mapstyle-btn" data-style="dark" onclick="changeMapStyle('dark')" id="mapstyle-dark-btn">Темный режим</button>
                </div>
                <p style="font-size: 12px; color: #999; margin-top: 15px;" id="current-mapstyle-container"><strong id="current-mapstyle"></strong></p>
            </div>
        </div>
    </div>
    <button class="ai-fab-btn" onclick="toggleGlobalChat()" title="ИИ Ассистент">
    🤖
</button>
<div class="ai-hint-bubble" id="ai-hint"></div>

<div id="global-ai-modal">
    <div class="modal-header" style="background: rgba(108, 92, 231, 0.1);">
        <h2 style="color: #6C5CE7; margin:0;">🤖 ИИ Гид</h2>
        <span class="close-btn" onclick="toggleGlobalChat()">✕</span>
    </div>

    <div class="chat-section" style="flex: 1; max-height: none; background: transparent; border: none;">
        <div id="global-chat-history" class="chat-history">
            <div class="message ai">
                Привет! Я твой виртуальный гид по Таразу. Я могу помочь построить маршрут, рассказать историю или найти где поесть. Спрашивай!
            </div>
        </div>
        
        <div class="input-area" style="background: white; border-top: 1px solid #eee;">
            <input type="text" id="global-user-input" placeholder="Задай вопрос о городе..." autocomplete="off">
            <button onclick="sendGlobalMessage()" style="background: #6C5CE7;">➤</button>
        </div>
    </div>
</div>

<!-- МОДАЛЬНОЕ ОКНО AR -->
<div id="ar-modal" class="modal-overlay" style="display: none; z-index: 9999;">
    <div class="ar-modal-container">
        <div class="ar-modal-header">
            <h2 style="margin: 0;">🔍 Дополненная реальность</h2>
            <span class="close-btn" onclick="closeARModal()">✕</span>
        </div>
        <iframe id="ar-iframe"
            frameborder="0"
            scrolling="yes"
            seamless="seamless"
            style="display:block; width:100%; height:calc(100% - 50px); border:none;"
            allow="camera;gyroscope;accelerometer;magnetometer;xr-spatial-tracking;microphone;">
        </iframe>
    </div>
</div>

<!-- МОДАЛЬНОЕ ОКНО QR КОДА -->
<div id="qr-modal" class="modal-overlay" style="display: none; z-index: 9998;">
    <div class="qr-modal-container">
        <div class="qr-modal-content">
            <img id="qr-image" src="" alt="QR Code" class="qr-image">
            <span class="close-btn" onclick="closeQRModal()" style="position: absolute; top: 10px; right: 10px; font-size: 28px; background: rgba(0,0,0,0.5); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">✕</span>
        </div>
    </div>
</div>

<div id="qr-modal-2" class="modal-overlay" style="display: none; z-index: 9997;">
    <div class="qr-modal-container">
        <div class="qr-modal-content">
            <img id="qr-image-2" src="" alt="QR Code 2" class="qr-image">
            <span class="close-btn" onclick="closeQRModal2()" style="position: absolute; top: 10px; right: 10px; font-size: 28px; background: rgba(0,0,0,0.5); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">✕</span>
        </div>
    </div>
</div>

    <script>
        /* --- НАСТРОЙКИ (ЭТО НУЖНО ИЗМЕНИТЬ) --- */
        
        // 1. СЮДА ВСТАВИТЬ ССЫЛКУ ИЗ N8N (Production URL)
        const N8N_WEBHOOK_URL = 'https://abibabi.app.n8n.cloud/webhook/ask-tara'; 
        // 2. БАЗА ДАННЫХ МЕСТ (Координаты, Имя, Видео)
        // Добавлены уникальные `id` для каждой точки — используются для локализации и хранения в избранном/истории
        const places = [
            {
                id: "karakhan",
                name: "Мавзолей Карахана",
                lat: 42.8988, lng: 71.3850,
                video: "https://ik.imagekit.io/99iuqyild/VIdeoFloder/karakhan.MOV",
                image: "карахан/x.jpg",
                images: ["карахан/x.jpg", "карахан/xx.jpg", "карахан/xxx.jpg"],
                icon: "карахан.png",
                description: "Мавзолей Карахана — один из главных архитектурных памятников XI века. Он был построен в честь Абу Махмуда Карахана, основателя Караханидской династии. Мавзолей служил не только местом упокоения, но и символом исламской культуры региона. Здание выполнено из кирпича и камня, отличается устойчивостью и величественностью. Вход расположен с южной стороны, а фасад обращён к улице Карахан. Памятник является местом паломничества мусульман и привлекает много туристов."
            },
            {
                id: "two_mausoleums",
                name: "Мавзолеи Айша-Биби и Бабаджи-Хатун",
                lat: 42.8337, lng: 71.2107,
                video: "https://ik.imagekit.io/99iuqyild/VIdeoFloder/aisha.MOV",
                image: "Two mausoleums stand.png",
                images: ["бабаджа хатун/photo.jpg", "айша биби/1200_0_52f5c8faad3d120ef233efc14a3377c1.jpg", "айша биби/Aisha_bibi.png", "айша биби/_gluster_2023_7_25_8d3020f74737a69ae862587789264eed_original.230594.jpg", "бабаджа хатун/download.jpg", "бабаджа хатун/fofofo.jpg"],
                icon: "Two mausoleums stand.png",
                description: "Комплекс двух мавзолеев — Айша-Биби и Бабаджи-Хатун — один из самых значимых памятников средневекового Казахстана, расположенный в селе Айша-Биби в 18 км от Тараза.",
                descriptions: [
                    "Мавзолей Айша-Биби — уникальный памятник XII века, расположен в селе Айша-Биби в 18 км от Тараза.",
                    "Мавзолей полностью облицован резной терракотой с замысловатым орнаментом, который считается шедевром исламского искусства.",
                    "Согласно легенде, это святилище было воздвигнуто в память о возлюбленной принца. Здание входит в список памятников ЮНЕСКО и является одной из самых красивых архитектурных работ средневекового Казахстана.",
                    "Мавзолей Бабаджи-Хатун — памятник XI века, расположенный рядом с мавзолеем Айша-Биби.",
                    "Отличается редким шестнадцатигранным куполом, что делает его уникальным в архитектурном плане. Фасады ориентированы на восток.",
                    "Мавзолей посвящён почтённой женщине времён Караханидской династии. Строение из жёлтого кирпича украшено геометрическим орнаментом. Два мавзолея часто посещают вместе, так как они находятся рядом и оформляют единый комплекс исторических памятников."
                ]
            },
            {
                id: "tekturmas",
                name: "Гора Тектурмас и мавзолей Святого Тектурмаса",
                lat: 42.8773, lng: 71.4181,
                video: "https://ik.imagekit.io/99iuqyild/VIdeoFloder/tekturmas.MOV",
                image: "тектурмас/k.jpg",
                images: ["тектурмас/k.jpg", "тектурмас/kk.jpg", "тектурмас/kkk.jpg"],
                icon: "тектурмас.png",
                description: "Гора Тектурмас — священное место на юго-восточной окраине города. На вершине холма расположен мавзолей святого Тектурмаса, который считается святилищем ислама. Название горы переводится как «железная плита». Место популярно как смотровая площадка, откуда открывается панорамный вид на весь Тараз и окружающие степи. Здесь часто совершают молитвы паломники со всего мира. Чистый воздух и красивый ландшафт делают это место идеальным для медитации."
            },
            {
                id: "clock_and_taraz",
                name: "Арбат",
                lat: 42.899650, lng: 71.392690,
                video: "https://ik.imagekit.io/99iuqyild/VIdeoFloder/Arbat.mp4",
                image: "Clocks and taraz.png",
                images: [
                    "часовая башня/h.jpg",
                    "часовая башня/hh.jpg",
                    "часовая башня/hhh.jpg",
                    "древний тараз/ambambaba.jpg",
                    "древний тараз/ambam.jpg",
                    "древний тараз/aaa.jpg"
                ],
                icon: "Clocks and taraz.png",
                description: "Арбат — объединённая точка, включающая Часовую башню и археологический комплекс Древний Тараз.",
                descriptions: [
                    "<b>Часовая башня</b> — городской ориентир и символ центра Тараза. Это культовое здание с часами было воздвигнуто как памятник градостроению и современности.",
                    "<b>Часовая башня</b> расположена на Арбате, рядом с историко-культурной зоной «Коне Тараз». Её архитектура сочетает традиционные казахские элементы с современным дизайном.",
                    "<b>Часовая башня</b> работает 24/7 и служит точкой встреч для туристов и местных жителей. По вечерам башня красиво подсвечивается.",
                    "<b>Древний Тараз</b> — археологический комплекс, расположенный рядом с Часовой башней. Здесь можно увидеть остатки древних построек и улиц.",
                    "<b>Древний Тараз</b>: комплекс «Коне Тараз» позволяет окунуться в атмосферу средневекового города, познакомиться с бытом и культурой предков.",
                    "<b>Древний Тараз</b> — это уникальное место для любителей истории и археологии, где прошлое встречается с настоящим."
                ]
            },
            {
                id: "victory_park",
                name: "Парк Победы (Парк Жеңіс)",
                lat: 42.895106, lng: 71.354974,
                video: "https://ik.imagekit.io/jwtsrra5g/New%20Folder/%D0%B6%D0%B5%D0%BD%D0%B8%D1%81.MP4",
                image: "женіс парк/c.jpg",
                images: ["женіс парк/c.jpg", "женіс парк/cc.jpg", "женіс парк/ccc.jpg"],
                icon: "женіс парк.png",
                description: "Парк Победы — главный мемориальный парк города, посвящённый Победе в Великой Отечественной войне. Вход расположен с улицы Жансугурова, 1А, рядом с Залом славы. Парк содержит памятники героям, мемориальные доски и красивые аллеи. Здесь часто проводятся торжественные мероприятия, особенно 9 мая. Место атмосферное и вдохновляющее, где можно узнать о истории региона и подвигах его защитников."
            },
            {
                id: "kali_yunus",
                name: "Баня Кали-Юнуса",
                lat: 42.894456, lng: 71.387728,
                video: "https://ik.imagekit.io/jwtsrra5g/New%20Folder/%D0%B1%D0%B0%D0%BD%D1%8F.MP4",
                image: "баня юнуса/download.jpg",
                images: ["баня юнуса/download.jpg", "баня юнуса/ima.jpg", "баня юнуса/images.jpg"],
                icon: "баняюнуса.png",
                description: "Баня Кали-Юнуса — памятник хозяйственно-бытовой архитектуры начала XX века. Историческая баня с 11 помещениями, вход с улицы Байзак батыра, 40/1. Это редкий пример традиционной казахской бани с системой отопления и вентиляции. Баня демонстрирует уровень комфорта и развитие инженерной мысли в регионе. Здание внесено в реестр памятников и тщательно восстанавливается."
            },
            {
                id: "hibatulla_mosque",
                name: "Мечеть имени Хибатулла Тарази",
                lat: 42.899900, lng: 71.3533,
                video: "https://ik.imagekit.io/99iuqyild/VIdeoFloder/mechet.MOV",
                image: "мечеть тарази/z.jpg",
                images: ["мечеть тарази/z.jpg", "мечеть тарази/zz.jpg", "мечеть тарази/zzz.jpg"],
                icon: "мечетьтарази.png",
                description: "Мечеть имени Хибатулла Тарази — главная мечеть города, построенная в 2008 году. Современное культовое сооружение с семью куполами, вход с проспекта Толе би, 89Б. Архитектура мечети сочетает традиционные исламские мотивы с современным дизайном. Это большое и светлое здание вмещает тысячи верующих. Мечеть играет важную роль в духовной жизни города и служит местом встреч мусульманской общины."
            },
            {
                id: "presidents_park",
                name: "Парк Первого Президента",
                lat: 42.900930, lng: 71.340323,
                video: "https://ik.imagekit.io/jwtsrra5g/New%20Folder/%D0%BF%D0%B0%D1%80%D0%BA%20%D0%BF%D1%80%D0%B5%D0%B7%D0%B8%D0%B4%D0%B5%D0%BD%D1%82%D0%B0.MP4",
                image: "парк первого президента/n.jpg",
                images: ["парк первого президента/n.jpg", "парк первого президента/nn.jpg", "парк первого президента/nnn.jpg"],
                icon: "парк первого президента.png",
                description: "Парк Первого Президента — благоустроенный парк с современной инфраструктурой. Здесь находятся скульптуры, памятники и красивые садовые композиции. Парк идеален для прогулок семьями и отдыха. На территории парка расположены игровые зоны для детей и спортивные площадки. Парк демонстрирует стремление города к развитию и созданию комфортной среды для жизни граждан."
            },
            {
                id: "zhambyl_museum",
                name: "Жамбылский историко-краеведческий музей",
                lat: 42.900706, lng: 71.394491,
                video: "https://ik.imagekit.io/jwtsrra5g/New%20Folder/%D0%B8%D1%81%D1%82%D0%BE%D1%80%D0%B8%D0%BA%D0%BE.MP4",
                image: "жамбылский историко краеведческий музей/b.jpg",
                images: ["жамбылский историко краеведческий музей/b.jpg", "жамбылский историко краеведческий музей/bb.jpg", "жамбылский историко краеведческий музей/bbb.jpg"],
                icon: "Жамбылский историко-краеведческий музей.png",
                description: "Жамбылский историко-краеведческий музей — один из старейших музеев региона, расположен на проспекте Толе би, 18/8. Рядом с Часовой башней и Арбатом, музей содержит богатую коллекцию артефактов, документов и предметов искусства. Экспозиции рассказывают о жизни региона на протяжении веков. Музей способствует сохранению и популяризации культурного наследия казахского народа."
            },
            {
                id: "kazakh_khanate",
                name: "Мемориал Казахского ханства",
                lat: 42.890213, lng: 71.3116711,
                video: "https://ik.imagekit.io/99iuqyild/VIdeoFloder/khandygy.mp4?updatedAt=1771022278568",
                image: "казак хандыгы описание/20151221002320.jpg",
                images: ["казак хандыгы описание/20151221002320.jpg", "казак хандыгы описание/e31ace2a15a7c70645ad83df9ecd43b0_XL.jpg", "казак хандыгы описание/_gluster_2024_2_8_378a91f4eefe392c6619640dfc9b2b6b_original.773477.png"],
                icon: "казак хандыгы.png",
                description: "Мемориал Казахского ханства — величественный памятник, посвящённый исторической эпохе независимого Казахского ханства. Этот монумент отражает величие и независимость казахского народа на протяжении веков. Расположенный в центре Тараза, мемориал служит напоминанием о славной истории казахской государственности и достижениях ханов, правивших этими великими землями. Памятник привлекает как местных жителей, так и туристов, желающих узнать больше об истории Казахстана и наследии Казахского ханства."
            },
            {
                id: "chef_star",
                name: "Chef Star",
                lat: 42.895293, lng: 71.377539,
                video: "https://ik.imagekit.io/99iuqyild/VIdeoFloder/kofe.mp4",
                image: null,
                images: [],
                icon: null,
                description: "⭐ Рейтинг: 4.5 звезды\n\n🕒 Время работы: Ежедневно с 08:00 до 01:00\n\n📞 Связь: +7 707 714 0900\n\n📍 Адрес: просп. Абая 136, Тараз\n\nЭто уютное место, подходящее как для завтраков, так и для вечернего отдыха."
            }
        ];

        /* --- LOCALES: перевод интерфейса и мест --- */
        const LOCALES = {};

        LOCALES.ru = {
            ui: {
                app_title: 'Гид по Таразу',
                language: 'Язык',
                languages_title: 'Языки',
                lang_ru: 'Русский',
                lang_kk: 'Қазақша',
                lang_en: 'English',
                tooltip: { search: 'Поиск', language: 'Язык', history: 'История', favorites: 'Избранное' },
                modal: {
                    loading: 'Загрузка...',
                    search_title: '🔍 Поиск достопримечательностей',
                    search_placeholder: 'Введи название...',
                    not_found: 'Не найдено',
                    history_empty: 'История пуста. Задавай вопросы об достопримечательностях!',
                    favorites_empty: 'Добавляй понравившиеся места!',
                    coords: 'Координаты',
                    chat_welcome: 'Привет! Посмотри видео и прочитай описание, а затем спроси меня о чем-нибудь интересном про это место.',
                    chat_typing: 'Печатает...',
                    chat_placeholder: 'Что хочешь узнать?',
                    language_current: 'Русский',
                    current_language_label: 'Текущий язык:',
                    chat_label: 'Спроси об этом месте',
                    history_title: '🕑 История запросов',
                    favorites_title: '⭐ Избранные места',
                    mapstyle_title: '🎨 Стиль карты',
                    mapstyle_light: 'Светлый режим',
                    mapstyle_dark: 'Темный режим',
                    mapstyle_current: 'Текущий:',
                    search_go: '📍 Перейти',
                    added_fav: 'добавлено в избранное',
                    error_empty_answer: 'Ошибка: Пустой ответ.',
                    error_server: 'Ошибка связи с сервером.'
                }
            },
            places: {
                two_mausoleums: { name: 'Мавзолеи Айша-Биби и Бабаджи-Хатун', descriptions: ['Мавзолей Айша-Биби — уникальный памятник XII века, расположен в селе Айша-Биби в 18 км от Тараза.', 'Мавзолей полностью облицован резной терракотой с замысловатым орнаментом, который считается шедевром исламского искусства.', 'Согласно легенде, это святилище было воздвигнуто в память о возлюбленной принца. Здание входит в список памятников ЮНЕСКО и является одной из самых красивых архитектурных работ средневекового Казахстана.', 'Мавзолей Бабаджи-Хатун — памятник XI века, расположенный рядом с мавзолеем Айша-Биби.', 'Отличается редким шестнадцатигранным куполом, что делает его уникальным в архитектурном плане. Фасады ориентированы на восток.', 'Мавзолей посвящён почтённой женщине времён Караханидской династии. Строение из жёлтого кирпича украшено геометрическим орнаментом. Два мавзолея часто посещают вместе, так как они находятся рядом и оформляют единый комплекс исторических памятников.'] },
                karakhan: { name: 'Мавзолей Карахана', description: 'Мавзолей Карахана — один из главных архитектурных памятников XI века. Он был построен в честь Абу Махмуда Карахана, основателя Караханидской династии. Мавзолей служил не только местом упокоения, но и символом исламской культуры региона. Здание выполнено из кирпича и камня, отличается устойчивостью и величественностью. Вход расположен с южной стороны, а фасад обращён к улице Карахан. Памятник является местом паломничества мусульман и привлекает много туристов.' },
                aisha_bibi: { name: 'Мавзолей Айша-Биби', description: 'Мавзолей Айша-Биби — уникальный памятник XII века, расположен в селе Айша-Биби в 18 км от Тараза. Мавзолей полностью облицован резной терракотой с замысловатым орнаментом, который считается шедевром исламского искусства. Восточный фасад служит главным входом. Согласно легенде, это святилище было воздвигнуто в память о возлюбленной принца. Здание входит в список памятников ЮНЕСКО и является одной из самых красивых архитектурных работ средневекового Казахстана.' },
                babadzha_khatun: { name: 'Мавзолей Бабаджи-Хатун', description: 'Мавзолей Бабаджи-Хатун — памятник XI века, расположенный рядом с мавзолеем Айша-Биби. Отличается редким шестнадцатигранным куполом, что делает его уникальным в архитектурном плане. Фасады ориентированы на восток. Мавзолей посвящён почтённой женщине времён Караханидской династии. Строение из жёлтого кирпича украшено геометрическим орнаментом. Два мавзолея часто посещают вместе, так как они находятся рядом и оформляют единый комплекс исторических памятников.' },
                tekturmas: { name: 'Гора Тектурмас и мавзолей Святого Тектурмаса', description: 'Гора Тектурмас — священное место на юго-восточной окраине города. На вершине холма расположен мавзолей святого Тектурмаса, который считается святилищем ислама. Название горы переводится как «железная плита». Место популярно как смотровая площадка, откуда открывается панорамный вид на весь Тараз и окружающие степи. Здесь часто совершают молитвы паломники со всего мира. Чистый воздух и красивый ландшафт делают это место идеальным для медитации.' },
                clock_and_taraz: {
                    name: 'Арбат',
                    descriptions: [
                        '<b>Часовая башня</b> — городской ориентир и символ центра Тараза. Это культовое здание с часами было воздвигнуто как памятник градостроению и современности.',
                        '<b>Часовая башня</b> расположена на Арбате, рядом с историко-культурной зоной «Коне Тараз». Её архитектура сочетает традиционные казахские элементы с современным дизайном.',
                        '<b>Часовая башня</b> работает 24/7 и служит точкой встреч для туристов и местных жителей. По вечерам башня красиво подсвечивается.',
                        '<b>Древний Тараз</b> — археологический комплекс, расположенный рядом с Часовой башней. Здесь можно увидеть остатки древних построек и улиц.',
                        '<b>Древний Тараз</b>: комплекс «Коне Тараз» позволяет окунуться в атмосферу средневекового города, познакомиться с бытом и культурой предков.',
                        '<b>Древний Тараз</b> — это уникальное место для любителей истории и археологии, где прошлое встречается с настоящим.'
                    ]
                },
                victory_park: { name: 'Парк Победы (Парк Жеңіс)', description: 'Парк Победы — главный мемориальный парк города, посвящённый Победе в Великой Отечественной войне. Вход расположен с улицы Жансугурова, 1А, рядом с Залом славы. Парк содержит памятники героям, мемориальные доски и красивые аллеи. Здесь часто проводятся торжественные мероприятия, особенно 9 мая. Место атмосферное и вдохновляющее, где можно узнать о истории региона и подвигах его защитников.' },
                kali_yunus: { name: 'Баня Кали-Юнуса', description: 'Баня Кали-Юнуса — памятник хозяйственно-бытовой архитектуры начала XX века. Историческая баня с 11 помещениями, вход с улицы Байзак батыра, 40/1. Это редкий пример традиционной казахской бани с системой отопления и вентиляции. Баня демонстрирует уровень комфорта и развитие инженерной мысли в регионе. Здание внесено в реестр памятников и тщательно восстанавливается.' },
                hibatulla_mosque: { name: 'Мечеть имени Хибатулла Тарази', description: 'Мечеть имени Хибатулла Тарази — главная мечеть города, построенная в 2008 году. Современное культовое сооружение с семью куполами, вход с проспекта Толе би, 89Б. Архитектура мечети сочетает традиционные исламские мотивы с современным дизайном. Это большое и светлое здание вмещает тысячи верующих. Мечеть играет важную роль в духовной жизни города и служит местом встреч мусульманской общины.' },
                presidents_park: { name: 'Парк Первого Президента', description: 'Парк Первого Президента — благоустроенный парк с современной инфраструктурой. Здесь находятся скульптуры, памятники и красивые садовые композиции. Парк идеален для прогулок семьями и отдыха. На территории парка расположены игровые зоны для детей и спортивные площадки. Парк демонстрирует стремление города к развитию и созданию комфортной среды для жизни граждан.' },
                zhambyl_museum: { name: 'Жамбылский историко-краеведческий музей', description: 'Жамбылский историко-краеведческий музей — один из старейших музеев региона, расположен на проспекте Толе би, 18/8. Рядом с Часовой башней и Арбатом, музей содержит богатую коллекцию артефактов, документов и предметов искусства. Экспозиции рассказывают о жизни региона на протяжении веков. Музей способствует сохранению и популяризации культурного наследия казахского народа.' },
                kazakh_khanate: { name: 'Мемориал Казахского ханства', description: 'Мемориал Казахского ханства — величественный памятник, посвящённый исторической эпохе независимого Казахского ханства. Этот монумент отражает величие и независимость казахского народа на протяжении веков. Расположенный в центре Тараза, мемориал служит напоминанием о славной истории казахской государственности и достижениях ханов, правивших этими великими землями. Памятник привлекает как местных жителей, так и туристов, желающих узнать больше об истории Казахстана и наследии Казахского ханства.' },
                chef_star: { name: 'Chef Star', description: '⭐ Рейтинг: 4.5 звезды\n\n🕒 Время работы: Ежедневно с 08:00 до 01:00\n\n📞 Связь: +7 707 714 0900\n\n📍 Адрес: просп. Абая 136, Тараз\n\nЭто уютное место, подходящее как для завтраков, так и для вечернего отдыха.' }
            }
        };

        LOCALES.kk = {
            ui: {
                app_title: 'Таразға байланысты құрылым',
                language: 'Тіл',
                languages_title: 'Тілдер',
                lang_ru: 'Русский',
                lang_kk: 'Қазақша',
                lang_en: 'English',
                tooltip: { search: 'Іздеу', language: 'Тіл', history: 'Тарих', favorites: 'Таңдаулы' },
                modal: {
                    loading: 'Жүктелуде...',
                    search_title: '🔍 Ескерткіштерді іздеу',
                    search_placeholder: 'Атауын енгізіңіз...',
                    not_found: 'Табылмады',
                    history_empty: 'Тарих бос. Сұрақ қойыңыз!',
                    favorites_empty: 'Ұнаған орындарды қосыңыз!',
                    coords: 'Координаттар',
                    chat_welcome: 'Сәлем! Бейнені көріңіз, сипаттамасын оқыңыз, кейін осы орын туралы сұрақ қойыңыз.',
                    chat_typing: 'Жазап жатыр...',
                    chat_placeholder: 'Не білгіңіз келеді?',
                    language_current: 'Қазақша',
                    current_language_label: 'Ағымдағы тіл:',
                    chat_label: 'Осы орын туралы сұраңыз',
                    history_title: '🕑 Сұраулар тарихы',
                    favorites_title: '⭐ Таңдаулы орындар',
                    mapstyle_title: '🎨 Карта стилі',
                    mapstyle_light: 'Жарық режим',
                    mapstyle_dark: 'Қараңғы режим',
                    mapstyle_current: 'Ағымдағы:',
                    search_go: '📍 Өту',
                    added_fav: 'таңдаулыларға қосылды',
                    error_empty_answer: 'Қате: Бос жауап.',
                    error_server: 'Сервермен байланыс қатесі.'
                }
            },
            places: {
                two_mausoleums: { name: 'Айша бибі және Бабаджа хатун кесенелері', descriptions: ['<b>Айша бибі</b> – 800 жылдан астам тарихы бар сәулет ескерткіші. Терракотамен безендірілген.', 'Айша бибі мен Қарахан туралы аңыз кең таралған.', 'XI–XII ғасырлардан сақталған.', '<b>Бабаджа хатун</b> – Айша бибі кесенесінің жанында орналасқан. X–XI ғасырларға жатады.', 'Тікбұрышты, қызыл кірпіштен салынған. Өрнектері күн бейнесіне ұқсайды.', 'Екі кесене қасында орналасқандықтан, тарихи ескерткіштердің біргелі кешенін құрайды.'] },
                karakhan: { name: 'Қарахан кесенесі', description: 'Қарахан кесенесі – 800 жылдан астам тарихы бар көне ескерткіш. Бірнеше рет бұзылып, қайта қалпына келтірілген. Тарихи маңызы өте зор, сонымен қатар көптеген аңыздармен байланысты. Қарахан X–XI ғасырларда Қарахан мемлекетін басқарған. Ол қарақытайлар мен қыпшақтарға қарсы күрес жүргізіп, ержүректігімен танылған. Кесене қаланың ішінде орналасқандықтан, туристер мен тұрғындардың назарын жиі аударады.' },
                aisha_bibi: { name: 'Айша бибі кесенесі', description: 'Айша бибі – 800 жылдан астам тарихы бар сәулет ескерткіші. Терракотамен безендірілген. Айша бибі мен Қарахан туралы аңыз кең таралған. XI–XII ғасырлардан сақталған.' },
                babadzha_khatun: { name: 'Бабаджа хатун кесенесі', descriptions: ['Бабаджа хатун – Айша бибі кесенесінің жанында орналасқан. X–XI ғасырларға жатады.', 'Тікбұрышты, қызыл кірпіштен салынған. Өрнектері күн бейнесіне ұқсайды.', 'Кесене Құраханид династиясы кезіндегі құрметті әйелдің ұлы құрметіне арналды.', 'Құрылыс жартылай кірпіштен салынған және геометриялық ою-өрнектермен безенген.', 'Екі құбеже қасында орналасқандықтан, тарихи ескерткіштердің біргелі кешенін құрайды.', 'Бабаджа хатун кесенесінің күмбезі ерекше пішінге ие. Ол көпқырлы шатыр тәрізді болып жасалған және Қазақстан аумағындағы сирек кездесетін сәулеттік үлгілердің бірі болып саналады.'] },
                tekturmas: { name: 'Тектүрмас кесенесі', description: 'Тектүрмас кесенесі – ежелден сақталған тарихи ескерткіштердің бірі. Ұзақ жылдар бойы сақталып, тек бір рет қана бұзылып, қайта жөнделген. Басқа кесенелерге қарағанда сыртқы ою-өрнегі қарапайым. Кесене маңында бұрын Ұлы Жібек жолына апаратын жол болған, қазіргі таңда ол тастармен жабылған. Тектүрмас XIV–XV ғасырларда ислам дінін таратуға үлес қосқан маңызды тұлға. Керек есімі – Сұлтан Махмұд хан.' },
                clock_and_taraz: { name: 'Арбат', descriptions: ['<b>Көне Тараз және Сағат мұнарасы</b> – Тараз қаласының ең басты әрі ең әдемі саябақтарының бірі. Ол «МАРТ» супермаркетінің қасында, бұрынғы Шахристан аумағында орналасқан.', 'Бұл саябақ Жамбыл тарихи-өлкетану мұражайы мен Сағат мұнарасын байланыстырады.', '<b>Көне Тараз</b> тек әдемі ғана емес, тарихи маңызы зор орын. Мұнда Жамбыл облысында өтетін көптеген мерекелік іс-шаралар ұйымдастырылады.', '<b>Сағат мұнарасы</b> Көне Тараз бен бұрынғы Шахристанның ортасында орналасқан. Ол – Тараз қаласындағы ең биік ғимараттардың бірі.', 'Мұнараның сыртқы келбеті Лондондағы Биг Бенге ұқсас болғанымен, ұлттық ою-өрнектермен безендірілген. Сағат уақытты дәл көрсетеді.', 'Сағат мұнарасы тек уақыт көрсететін нысан ғана емес, сонымен қатар қала тұрғындары мен туристер үшін кездесу орны ретінде де кеңінен қолданылады. Кешкі уақытта мұнара жарықтандырылып, қаланың көркін ерекше айқындайды.'] },
                kali_yunus: { name: 'Қали-Юнус моншасы', description: 'Қали-Юнус моншасы – Тараз қаласындағы XIX ғасырдың сәулет ескерткіші. Ол шаруашылық-тұрмыстық мақсатта пайдаланылған. Ғимараттың он бөлмесінің бір бөлігі бастапқы күйінде сақталған, біреуі қайта қалпына келтірілген. Жалпы ауданы – 18×25 м. Қабырғаларының қалыңдығы – 0.8 м, биіктігі – 2.5–3 м, ал күмбезге дейінгі биіктігі 4–6 м. 1982 жылы КСРО кезінде қайта қалпына келтіріліп, қорғауға алынған. Тәуелсіздік алғаннан кейін Қазақстанның тарихи ескерткіштері қатарына енгізілді.' },
                hibatulla_mosque: { name: 'Хибатулла мешіті', description: 'Хибатулла мешіті – Тараз қаласындағы ең үлкен мешіттердің бірі. Жанында католик шіркеуі орналасқан. Бұл Қазақстанның зайырлы мемлекет екенін көрсетеді. Мешіт жанында медресе бар, онда ислам діні мен араб тілі оқытылады.' },
                presidents_park: { name: 'Бірінші Президент саябағы', description: 'Бірінші Президент саябағы – 2001 жылы құрылған, 2011 жылдан бастап халыққа ашылған. Ортасында ту орнатылған монумент бар. Оның айналасында үш бүркіт бейнеленген. Олар еркіндік, зайырлылық және тәуелсіздікті білдіреді.' },
                zhambyl_museum: { name: 'Жамбыл тарихи-өлкетану мұражайы', description: 'Жамбыл тарихи-өлкетану мұражайы – мұражайдың 100 жылдан астам тарихы бар. Онда Жамбыл облысының археологиялық қазбалары сақталған. 1931 жылдан бастап жұмыс істейді. 1973 жылы жаңа ғимаратқа көшкен. 2002 жылы толық жөндеуден өткен. Қазіргі таңда мұражай қорында 40 мыңнан астам экспонат бар.' },
                victory_park: { name: 'Жеңіс саябағы', description: 'Жеңіс саябағы – Ұлы Отан соғысына арналған. Мұнда мәңгілік алау, танктер мен артиллериялық қарулар қойылған. Саябақтың ортасында Мәңгілік от орналасқан. Онда соғысқа қатысқан батырлардың есімдері жазылған. Саябақ соғыста қаза тапқан батырларды еске алу мақсатында құрылған.' },
                kazakh_khanate: { name: 'Қазақ хандығы монументі', description: 'Қазақ хандығы монументі – Тараз қаласының шетінде, «Тараз-Арена» алдында орналасқан. Ол Керей мен Жәнібек хандарға арналған. Бұл ескерткіштің тарихи маңызы өте зор. Керей мен Жәнібек Қазақ хандығын құрған тұлғалар. Монумент аумағы 3.5 гектарды алып жатыр. Ортасында биік ақ стелла, екі жағында Керей мен Жәнібек мүсіндері орналасқан. 2015 жылы салынған.' },
                chef_star: { name: 'Chef Star', description: '⭐ Рейтинг: 4.5 жұлдыз\n\n🕒 Іске кірісу уақыты: Күнделік 08:00-дан 01:00-ге дейін\n\n📞 Байланыс: +7 707 714 0900\n\n📍 Адресі: просп. Абая 136, Тараз\n\nБұл ыңғайлы орын, түстің ас қабылдау үшін де, кешкі демалыс үшін де сәйкес.' }
            }
        };

        LOCALES.en = {
                            clock_and_taraz: {
                                name: 'Arbat',
                                descriptions: [
                                    '<b>Clock Tower</b> is a city landmark and symbol of the center of Taraz. This iconic building with a clock was erected as a monument to urban planning and modernity.',
                                    '<b>Clock Tower</b> is located on the Arbat, next to the historical and cultural zone "Kone Taraz". Its architecture combines traditional Kazakh elements with modern design.',
                                    '<b>Clock Tower</b> operates 24/7 and serves as a meeting point for tourists and locals. In the evenings, the tower is beautifully illuminated.',
                                    '<b>Ancient Taraz</b> is an archaeological complex located next to the Clock Tower. Here you can see the remains of ancient buildings and streets.',
                                    '<b>Ancient Taraz</b>: The "Kone Taraz" complex allows you to immerse yourself in the atmosphere of a medieval city and get acquainted with the life and culture of ancestors.',
                                    '<b>Ancient Taraz</b> is a unique place for history and archaeology lovers, where the past meets the present.'
                                ]
                            },
            ui: {
                app_title: 'Taraz Guide',
                language: 'Language',
                languages_title: 'Languages',
                lang_ru: 'Русский',
                lang_kk: 'Қазақша',
                lang_en: 'English',
                tooltip: { search: 'Search', language: 'Language', history: 'History', favorites: 'Favorites' },
                modal: {
                    loading: 'Loading...',
                    search_title: '🔍 Search places',
                    search_placeholder: 'Type a name...',
                    not_found: 'Not found',
                    history_empty: 'History is empty. Ask about places!',
                    favorites_empty: 'Add favorite places!',
                    coords: 'Coordinates',
                    chat_welcome: 'Hi! Watch the video and read the description, then ask me something interesting about this place.',
                    chat_typing: 'Typing...',
                    chat_placeholder: 'What do you want to know?',
                    language_current: 'English',
                        current_language_label: 'Current language:',
                        chat_label: 'Ask about this place',
                    history_title: '🕑 Query history',
                    favorites_title: '⭐ Favorites',
                    mapstyle_title: '🎨 Map style',
                    mapstyle_light: 'Light mode',
                    mapstyle_dark: 'Dark mode',
                    mapstyle_current: 'Current:',
                    search_go: '📍 Go',
                    added_fav: 'added to favorites',
                    error_empty_answer: 'Error: Empty answer.',
                    error_server: 'Server connection error.'
                }
            },
            places: {
                two_mausoleums: { name: 'Aisha-Bibi and Babadzha-Khatun Mausoleums', descriptions: ['The Aisha-Bibi Mausoleum is a unique 12th-century monument located in the village of Aisha-Bibi, 18 km from Taraz.', 'The mausoleum is completely covered with intricate carved terracotta ornamentation, which is considered a masterpiece of Islamic art.', 'According to legend, this sanctuary was erected in memory of the princes beloved. The building is included in the UNESCO heritage list and is one of the most beautiful architectural works of medieval Kazakhstan.', 'The Babadzha-Khatun Mausoleum is an 11th-century monument located next to the Aisha-Bibi Mausoleum.', 'It is distinguished by a rare sixteen-sided dome, which makes it architecturally unique. The facades are oriented to the east.', 'The mausoleum is dedicated to a respected woman of the Karakhanid dynasty. The structure is made of yellow brick and decorated with geometric ornamentation. The two mausoleums are often visited together as they are located nearby and form a unified complex of historical monuments.'] },
                karakhan: { name: 'Karakhan Mausoleum', description: 'The Karakhan Mausoleum is one of the major architectural monuments of the 11th century. It was built in honor of Abu Mahmud Karakhan, founder of the Karakhanid dynasty. The mausoleum served not only as a burial place but also as a symbol of Islamic culture in the region. The building is made of brick and stone, distinguished by its durability and grandeur. The entrance is located on the south side, and the facade faces Karakhan Street. The monument is a pilgrimage site for Muslims and attracts many tourists.' },
                aisha_bibi: { name: 'Aisha-Bibi Mausoleum', description: 'The Aisha-Bibi Mausoleum is a unique 12th-century monument located in the village of Aisha-Bibi, 18 km from Taraz. The mausoleum is completely covered with intricate carved terracotta ornamentation, which is considered a masterpiece of Islamic art. The eastern facade serves as the main entrance. According to legend, this sanctuary was erected in memory of the princes beloved. The building is listed as a UNESCO heritage site and is one of the most beautiful architectural works of medieval Kazakhstan.' },
                babadzha_khatun: { name: 'Babadzha-Khatun Mausoleum', description: 'The Babadzha-Khatun Mausoleum is an 11th-century monument located next to the Aisha-Bibi Mausoleum. It is distinguished by a rare sixteen-sided dome, which makes it architecturally unique. The facades are oriented to the east. The mausoleum is dedicated to a respected woman of the Karakhanid dynasty. The structure is made of yellow brick and decorated with geometric ornamentation. The two mausoleums are often visited together as they are located nearby and form a unified complex of historical monuments.' },
                tekturmas: { name: 'Tekturmas Mountain & Mausoleum', description: 'Tekturmas Mountain is a sacred site on the southeastern edge of the city. On the summit of the hill stands the mausoleum of Saint Tekturmas, which is considered a sanctuary of Islam. The name of the mountain translates as "iron slab". The place is popular as a viewpoint from which a panoramic view of all of Taraz and the surrounding steppes opens up. Pilgrims from all over the world often pray here. Clean air and beautiful landscape make this place ideal for meditation.' },
                clock_and_taraz: { name: 'Arbat', descriptions: ['<b>Clock Tower</b> is a city landmark and symbol of the center of Taraz. This iconic building with a clock was erected as a monument to urban planning and modernity.', '<b>Clock Tower</b> is located on the Arbat, next to the historical and cultural zone "Kone Taraz". Its architecture combines traditional Kazakh elements with modern design.', '<b>Clock Tower</b> operates 24/7 and serves as a meeting point for tourists and locals. In the evenings, the tower is beautifully illuminated.', '<b>Ancient Taraz</b> is an archaeological complex located next to the Clock Tower. Here you can see the remains of ancient buildings and streets.', '<b>Ancient Taraz</b>: The "Kone Taraz" complex allows you to immerse yourself in the atmosphere of a medieval city and get acquainted with the life and culture of ancestors.', '<b>Ancient Taraz</b> is a unique place for history and archaeology lovers, where the past meets the present.'] },
                victory_park: { name: 'Victory Park (Zhenis Park)', description: 'Victory Park is the main memorial park of the city, dedicated to Victory in the Great Patriotic War. The entrance is located on Zhansugurov Street, 1A, near the Hall of Fame. The park contains monuments to heroes, memorial plaques, and beautiful avenues. Festive events are often held here, especially on May 9. The place is atmospheric and inspiring, where you can learn about the region\'s history and the exploits of its defenders.' },
                kali_yunus: { name: 'Kali-Yunus Bathhouse', description: 'The Kali-Yunus Bathhouse is a monument of household and everyday architecture from the early 20th century. A historic bathhouse with 11 rooms, entrance from Bayzak Batyr Street, 40/1. This is a rare example of a traditional Kazakh bathhouse with a heating and ventilation system. The bathhouse demonstrates the level of comfort and development of engineering thought in the region. The building is listed in the register of monuments and is being carefully restored.' },
                hibatulla_mosque: { name: 'Hibatulla Tarazi Mosque', description: 'The city’s main mosque, a modern religious complex.' },
                presidents_park: { name: 'First President Park', description: 'First President Park is a well-maintained park with modern infrastructure. It features sculptures, monuments, and beautiful garden compositions. The park is ideal for family walks and recreation. The park has children\'s play areas and sports facilities. The park demonstrates the city\'s desire to develop and create a comfortable environment for residents.' },
                zhambyl_museum: { name: 'Zhambyl Historical Museum', description: 'One of the region’s oldest museums with extensive collections.' },
                kazakh_khanate: { name: 'Memorial of the Kazakh Khanate', description: 'The Memorial of the Kazakh Khanate is a magnificent monument dedicated to the historical era of the independent Kazakh Khanate. This monument reflects the grandeur and independence of the Kazakh people throughout the centuries. Located in the center of Taraz, the memorial serves as a reminder of the glorious history of Kazakh statehood and the achievements of the khans who ruled these great lands. The monument attracts both local residents and tourists who wish to learn more about the history of Kazakhstan and the legacy of the Kazakh Khanate.' },
                chef_star: { name: 'Chef Star', description: '⭐ Rating: 4.5 stars\n\n🕒 Working hours: Daily from 08:00 to 01:00\n\n📞 Contact: +7 707 714 0900\n\n📍 Address: Ave. Abaya 136, Taraz\n\nThis is a cozy place suitable for both breakfast and evening relaxation.' }
            }
        };

        // Helper: get translated UI string
        function t(path) {
            const parts = path.split('.');
            let node = LOCALES[currentLanguage] && LOCALES[currentLanguage].ui;
            for (let p of parts) {
                if (!node) return null;
                node = node[p];
            }
            if (node) return node;
            // fallback to ru
            node = LOCALES['ru'] && LOCALES['ru'].ui;
            for (let p of parts) {
                if (!node) return path;
                node = node[p];
            }
            return node || path;
        }

        function getLocalizedPlaceField(placeId, field) {
            return (LOCALES[currentLanguage] && LOCALES[currentLanguage].places && LOCALES[currentLanguage].places[placeId] && LOCALES[currentLanguage].places[placeId][field]) ||
                (LOCALES['ru'] && LOCALES['ru'].places && LOCALES['ru'].places[placeId] && LOCALES['ru'].places[placeId][field]) || null;
        }

        /* --- ЛОГИКА ПРИЛОЖЕНИЯ --- */
        
        const tg = window.Telegram.WebApp;
        tg.expand(); // Расширяем на весь экран

        // Переменные для управления стилями карты
        let currentMapStyle = localStorage.getItem('mapStyle') || 'light';
        let currentTileLayer = null;

        // Определение слоев карты
        const mapLayers = {
            light: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: 'Map data &copy; OpenStreetMap',
                name: '☀️ Light'
            },
            dark: {
                url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; OpenStreetMap, &copy; CartoDB',
                name: '🌙 Dark'
            }
        };

        // Инициализация карты (Центр Тараза)
        const map = L.map('map').setView([42.8993, 71.3769], 13);
        
        // Функция смены стиля карты
        function changeMapStyle(style) {
            if (mapLayers[style]) {
                // Удаляем старый слой
                if (currentTileLayer) {
                    map.removeLayer(currentTileLayer);
                }
                
                // Добавляем новый слой
                const layer = mapLayers[style];
                currentTileLayer = L.tileLayer(layer.url, {
                    attribution: layer.attribution,
                    maxZoom: 19
                }).addTo(map);
                
                // Сохраняем выбор
                currentMapStyle = style;
                localStorage.setItem('mapStyle', style);
                
                // Применяем тёмную тему, если выбран dark стиль
                if (style === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
                
                // Обновляем UI
                updateMapStyleUI();
                
                // Закрываем модальное окно
                closeAllModals();
            }
        }

        // Функция обновления UI кнопок стилей
        function updateMapStyleUI() {
            const buttons = document.querySelectorAll('.mapstyle-btn');
            buttons.forEach(btn => {
                if (btn.dataset.style === currentMapStyle) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            const styleNames = {
                light: '☀️ Light',
                dark: '🌙 Dark'
            };
            const currentStyleEl = document.getElementById('current-mapstyle');
            if (currentStyleEl) {
                currentStyleEl.innerText = 'Current: ' + styleNames[currentMapStyle];
            }
        }

        // Открытие модального окна выбора стиля карты
        function openMapStyle() {
            closeAllModals();
            updateMapStyleUI();
            const title = document.getElementById('mapstyle-modal-title');
            if (title) title.innerText = t('modal.mapstyle_title') || '🎨';
            
            // Обновляем текст кнопок в зависимости от языка
            const lightBtn = document.getElementById('mapstyle-light-btn');
            const darkBtn = document.getElementById('mapstyle-dark-btn');
            if (lightBtn) lightBtn.innerText = '☀️ ' + (t('modal.mapstyle_light') || 'Light mode');
            if (darkBtn) darkBtn.innerText = '🌙 ' + (t('modal.mapstyle_dark') || 'Dark mode');
            
            document.getElementById('mapstyle-modal').classList.add('active');
        }

        // Инициализация карты с сохраненным стилем
        changeMapStyle(currentMapStyle);

        let currentPlaceName = "";

        // Массив маркеров с их истинными координатами
        const markers = [];
        const markerStates = {}; // Сохраняем состояние маркеров
        const MIN_PIXEL_DISTANCE = 80; // Минимальное расстояние в пиксельном пространстве

        // Добавляем метки на карту с пользовательскими иконками и кластеризацией
        places.forEach(place => {
            let markerOptions = {};
            
            // Если есть пользовательская иконка, используем её
            if (place.icon) {
                // Размер зависит от типа метки
                let iconSize = [70, 100];
                let iconAnchor = [35, 100];
                let popupAnchor = [0, -100];
                
                // Для скамейки размер на 30% меньше
                if (place.id === 'presidents_bench') {
                    iconSize = [49, 70];
                    iconAnchor = [24.5, 70];
                    popupAnchor = [0, -70];
                }
                
                markerOptions.icon = L.icon({
                    iconUrl: place.icon,
                    iconSize: iconSize,
                    iconAnchor: iconAnchor,
                    popupAnchor: popupAnchor
                });
            }
            
            const marker = L.marker([place.lat, place.lng], markerOptions).addTo(map);
            marker.place = place;
            marker.on('click', (e) => handleMarkerClick(place, e));
            
            // Сохраняем маркер с его истинными координатами
            markers.push({
                marker: marker,
                place: place,
                trueLatLng: L.latLng(place.lat, place.lng),
                currentLatLng: L.latLng(place.lat, place.lng)
            });
            
            markerStates[place.id] = {
                isShifted: false,
                animationInProgress: false
            };
        });

        // Функция для вычисления расстояния в пиксельном пространстве
        function getPixelDistance(latlng1, latlng2) {
            const point1 = map.latLngToContainerPoint(latlng1);
            const point2 = map.latLngToContainerPoint(latlng2);
            return Math.sqrt(Math.pow(point1.x - point2.x, 2) + Math.pow(point1.y - point2.y, 2));
        }

        // Функция для плавной анимации маркера
        function animateMarker(markerData, targetLatLng, duration = 500) {
            const marker = markerData.marker;
            const startLatLng = markerData.currentLatLng;
            const startTime = Date.now();
            
            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function (ease-out-cubic)
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                const newLat = startLatLng.lat + (targetLatLng.lat - startLatLng.lat) * easeProgress;
                const newLng = startLatLng.lng + (targetLatLng.lng - startLatLng.lng) * easeProgress;
                
                marker.setLatLng([newLat, newLng]);
                markerData.currentLatLng = L.latLng(newLat, newLng);
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            };
            
            animate();
        }

        // Функция для расчета смещения маркеров
        function redistributeMarkers() {
            const zoom = map.getZoom();
            const shouldShift = zoom < 14; // Сдвигаем маркеры только при зуме < 14
            
            // Группируем ТОЛЬКО близкие маркеры (самые близкие соседи)
            const groups = [];
            const processed = new Set();
            
            markers.forEach((markerData, idx) => {
                if (processed.has(idx)) return;
                
                // Находим соседей этого маркера (расстояние < 100px)
                const neighbors = [];
                markers.forEach((otherMarker, otherIdx) => {
                    if (idx !== otherIdx && !processed.has(otherIdx)) {
                        const distance = getPixelDistance(markerData.trueLatLng, otherMarker.trueLatLng);
                        if (distance < 100) { // Только если расстояние < 100px
                            neighbors.push({ markerData: otherMarker, distance: distance, idx: otherIdx });
                        }
                    }
                });
                
                // Если есть близкие соседи, создаем группу
                if (neighbors.length > 0) {
                    // Сортируем соседей по расстоянию и берем только ближайших
                    neighbors.sort((a, b) => a.distance - b.distance);
                    
                    const group = [markerData];
                    processed.add(idx);
                    
                    // Добавляем в группу только ближайших соседей (расстояние < 70px)
                    neighbors.forEach(neighbor => {
                        if (neighbor.distance < 70 && group.length < 4) { // Макс 4 маркера в группе
                            group.push(neighbor.markerData);
                            processed.add(neighbor.idx);
                        }
                    });
                    
                    if (group.length > 1) {
                        groups.push(group);
                    }
                } else {
                    processed.add(idx);
                }
            });
            
            // Применяем смещения для групп с несколькими маркерами
            groups.forEach(group => {
                if (group.length > 1 && shouldShift) {
                    // Раздвигаем маркеры в ряд вокруг центра
                    const centerLatLng = group[0].trueLatLng;
                    const offsetLng = 0.0005; // Больший offset для расстояния между маркерами (~50 метров)
                    const offsetLat = 0.00015; // Небольшой offset по широте для визуального разделения
                    
                    group.forEach((markerData, idx) => {
                        const position = idx - (group.length - 1) / 2;
                        const shiftLng = centerLatLng.lng + position * offsetLng;
                        const shiftLat = centerLatLng.lat + Math.abs(position) * offsetLat * 0.3; // Небольшой разброс по широте
                        
                        const targetLatLng = L.latLng(shiftLat, shiftLng);
                        animateMarker(markerData, targetLatLng);
                        markerStates[markerData.place.id].isShifted = true;
                    });
                } else if (group.length > 1 && !shouldShift) {
                    // Возвращаем маркеры на истинные места
                    group.forEach(markerData => {
                        animateMarker(markerData, markerData.trueLatLng);
                        markerStates[markerData.place.id].isShifted = false;
                    });
                }
            });
            
            // Возвращаем маркеры не в группах на их истинные места
            markers.forEach(markerData => {
                if (!markerStates[markerData.place.id].isShifted && 
                    !shouldShift && 
                    getPixelDistance(markerData.currentLatLng, markerData.trueLatLng) > 1) {
                    animateMarker(markerData, markerData.trueLatLng);
                }
            });
        }

        // Обработчик события zoom и движения карты
        // map.on('zoom', redistributeMarkers);
        // map.on('moveend', redistributeMarkers);
        
        // Первичный расчет при загрузке
        // redistributeMarkers();
        // Открытие окна
        function openModal(place) {
            document.getElementById('modal').classList.add('active');
            // если есть перевод названия - используем его
            const localizedName = getLocalizedPlaceField(place.id, 'name') || place.name;
            document.getElementById('place-title').innerText = localizedName;
            
            // Показываем кнопки AR и 3D для Арбата (clock_and_taraz)
            const arBtn = document.getElementById('modal-ar-btn');
            const qrBtn = document.getElementById('modal-3d-btn');
            const qrBtn2 = document.getElementById('modal-3d-btn-2');
            
            if (place.id === 'clock_and_taraz') {
                arBtn.style.display = 'flex';
                qrBtn.style.display = 'flex';
                qrBtn2.style.display = 'flex';
            } else {
                arBtn.style.display = 'none';
                qrBtn.style.display = 'none';
                qrBtn2.style.display = 'none';
            }
            
            const video = document.getElementById('video-player');
            const videoContainer = document.querySelector('.video-container');
            
            // Всегда очищаем видеоконтейнер перед обновлением
            videoContainer.innerHTML = '';
            
            if (place.video) {
                // Показываем видео
                video.style.display = '';
                video.src = place.video;
                videoContainer.appendChild(video);
                videoContainer.style.display = '';
            } else if (place.image) {
                // Если нет видео, показываем фото вместо видео
                video.style.display = 'none';
                const img = document.createElement('img');
                img.src = place.image;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                videoContainer.appendChild(img);
                videoContainer.style.display = '';
            } else {
                videoContainer.style.display = 'none';
            }
            
            currentPlaceName = place.name; // keep original name for uniqueness
            currentPlace = place;
            
            // Создаём карточку информации - зигзаг макет (3 фото для обычных мест или 6 для особых)
            const placeInfoContainer = document.getElementById('place-info');
            
            let parts3 = [];
            
            // Проверяем, есть ли 6 описаний (для особых мест) - сначала ищем в локализованных, потом в основном объекте
            let localizedDescriptions = null;
            if (LOCALES[currentLanguage] && LOCALES[currentLanguage].places && LOCALES[currentLanguage].places[place.id] && LOCALES[currentLanguage].places[place.id].descriptions) {
                localizedDescriptions = LOCALES[currentLanguage].places[place.id].descriptions;
            }
            
            if (localizedDescriptions && localizedDescriptions.length >= 6) {
                parts3 = localizedDescriptions.slice(0, 6);
            } else if (place.descriptions && place.descriptions.length >= 6) {
                parts3 = place.descriptions.slice(0, 6);
            } else {
                // Разбиваем длинное описание на части (макс 3 части)
                const localizedDesc = getLocalizedPlaceField(place.id, 'description');
                const fullText = localizedDesc || place.description || t('modal.not_found');
                const parts = fullText.match(/[^.!?]*[.!?]+/g) || [fullText];
                
                // Собираем текст по 2-3 предложения на карточку
                let currentPart = '';
                for (let i = 0; i < parts.length && parts3.length < 3; i++) {
                    currentPart += parts[i];
                    if (currentPart.length > 80 || i === parts.length - 1 || parts3.length === 2) {
                        parts3.push(currentPart.trim());
                        currentPart = '';
                    }
                }
                
                // Если меньше 3 частей, добавляем полный текст в первую
                if (parts3.length === 0) {
                    parts3.push(fullText.substring(0, 150) + '...');
                }
            }
            
            let html = '';
            const displayCount = parts3.length;
            
            // Для Chef Star показываем только текст описания без карточек
            if (place.id === 'chef_star') {
                const localizedDesc = getLocalizedPlaceField(place.id, 'description');
                const fullText = localizedDesc || place.description || t('modal.not_found');
                html = `
                    <div class="info-row">
                        <div class="place-text-wrapper">
                            <p class="place-description">${fullText.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>
                `;
            } else {
                // Для обычных мест показываем карточки с фото и описанием
                for (let i = 0; i < displayCount && i < parts3.length; i++) {
                    // Используем массив images если существует, иначе используем одно image
                    const imageUrl = (place.images && place.images[i]) ? place.images[i] : (place.image || 'https://via.placeholder.com/110x110?text=No+Image');
                    html += `
                        <div class="info-row">
                            <img src="${imageUrl}" alt="${place.name}" class="place-image">
                            <div class="place-text-wrapper">
                                <h3 class="place-title">${localizedName}</h3>
                                <p class="place-description">${parts3[i]}</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            placeInfoContainer.innerHTML = html;
            
            // Очищаем историю чата
            document.getElementById('chat-history').innerHTML = `<div class="message ai">${t('modal.chat_welcome')}</div>`;
            
            // Сбрасываем класс расширения чата
            document.querySelector('.chat-section').classList.remove('expanded');
            
            // Обновляем кнопку избранного
            updateFavButton();
        }
        let currentPlace = null;

        function updateFavButton() {
            const isFavorite = favorites.find(f => f.id === currentPlace.id || f.name === currentPlaceName);
            const favBtn = document.getElementById('modal-fav-btn');
            if (isFavorite) {
                favBtn.textContent = '⭐';
                favBtn.style.opacity = '1';
            } else {
                favBtn.textContent = '☆';
                favBtn.style.opacity = '0.7';
            }
        }

        function addToFavoritesFromModal() {
            if (!currentPlace) return;
            // store minimal fav data: id, name, lat, lng for portability
            const favObj = { id: currentPlace.id || null, name: currentPlace.name, lat: currentPlace.lat, lng: currentPlace.lng };
            const existing = favorites.find(f => (f.id && favObj.id && f.id === favObj.id) || (!f.id && f.name === favObj.name));
            if (!existing) {
                favorites.push(favObj);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                alert(`✅ "${ getLocalizedPlaceField(currentPlace.id, 'name') || currentPlace.name }" ${t('modal.added_fav')}`);
            } else {
                favorites = favorites.filter(f => !((f.id && favObj.id && f.id === favObj.id) || (!f.id && f.name === favObj.name)));
                localStorage.setItem('favorites', JSON.stringify(favorites));
            }
            updateFavButton();
        }

        // Закрытие окна
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('video-player').pause();
            currentPlace = null;
            currentPlaceName = null;
        }

        // Открытие AR модального окна
        function openARModal() {
            const arModal = document.getElementById('ar-modal');
            const arIframe = document.getElementById('ar-iframe');
            
            // Устанавливаем источник MyWebAR
            arIframe.src = 'https://mywebar.com/pi/860490';
            
            // Показываем модальное окно
            arModal.style.display = 'flex';
            
            // Скрываем основное модальное окно при необходимости
            document.getElementById('modal').style.display = 'none';
        }

        // Закрытие AR модального окна
        function closeARModal() {
            const arModal = document.getElementById('ar-modal');
            const arIframe = document.getElementById('ar-iframe');
            
            // Очищаем источник iframe
            arIframe.src = '';
            
            // Скрываем AR модальное окно
            arModal.style.display = 'none';
            
            // Показываем основное модальное окно обратно
            document.getElementById('modal').style.display = '';
        }

        // Открытие QR модального окна
        function openQRModal() {
            const qrModal = document.getElementById('qr-modal');
            const qrImage = document.getElementById('qr-image');
            
            // Устанавливаем изображение QR кода
            qrImage.src = 'QRCODE.png';
            
            // Показываем модальное окно с плавной анимацией
            qrModal.style.display = 'flex';
            qrModal.style.animation = 'fadeIn 0.3s ease-in';
            
            // Скрываем основное модальное окно
            document.getElementById('modal').style.display = 'none';
        }

        // Закрытие QR модального окна
        function closeQRModal() {
            const qrModal = document.getElementById('qr-modal');
            
            // Скрываем QR модальное окно
            qrModal.style.display = 'none';
            
            // Показываем основное модальное окно обратно
            document.getElementById('modal').style.display = '';
        }

        // Открытие второго QR модального окна
        function openQRModal2() {
            const qrModal2 = document.getElementById('qr-modal-2');
            const qrImage2 = document.getElementById('qr-image-2');
            
            // Устанавливаем изображение второго QR кода
            qrImage2.src = 'QRCODE2.png';
            
            // Показываем модальное окно с плавной анимацией
            qrModal2.style.display = 'flex';
            qrModal2.style.animation = 'fadeIn 0.3s ease-in';
            
            // Скрываем основное модальное окно
            document.getElementById('modal').style.display = 'none';
        }

        // Закрытие второго QR модального окна
        function closeQRModal2() {
            const qrModal2 = document.getElementById('qr-modal-2');
            
            // Скрываем второе QR модальное окно
            qrModal2.style.display = 'none';
            
            // Показываем основное модальное окно обратно
            document.getElementById('modal').style.display = '';
        }

        // Отправка сообщения
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            // 1. Рисуем вопрос пользователя
            addMessage(text, 'user');
            input.value = '';
            
            // 2. Расширяем чат при первом сообщении
            expandChat();

            // 3. Рисуем индикатор загрузки
            const loadingId = addMessage('Печатает...', 'loading');

            try {
                // 4. Подготавливаем данные для отправки в N8N
                const payload = {
                    question: text,
                    context_place: currentPlace ? (getLocalizedPlaceField(currentPlace.id, 'name') || currentPlace.name) : 'General',
                    user_id: tg.initDataUnsafe?.user?.id || "guest_user",
                    language: currentLanguage,
                    timestamp: new Date().toISOString()
                };

                console.log('Отправляем в N8N:', payload); // Для отладки

                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                // Проверяем статус ответа перед парсингом JSON
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // 5. Удаляем "Печатает..." и показываем ответ
                document.getElementById(loadingId).remove();
                
                if (data.answer) {
                    addMessage(data.answer, 'ai');
                } else if (data.error) {
                    addMessage(`❌ Ошибка: ${data.error}`, 'ai');
                } else {
                    addMessage("Извини, я не смог получить ответ.", 'ai');
                }

            } catch (error) {
                console.error('Ошибка N8N:', error);
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) loadingElement.remove();
                addMessage(`❌ Ошибка соединения: ${error.message}`, 'ai');
            }
        }
        
        // Расширение чата
        function expandChat() {
            const chatSection = document.querySelector('.chat-section');
            chatSection.classList.add('expanded');
        }

        // Функция добавления пузырька сообщения
        function addMessage(text, type) {
            const chat = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerText = text;
            div.id = 'msg-' + Date.now();
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight; // Прокрутка вниз
            return div.id;
        }

        /* === НОВЫЕ ФУНКЦИИ ИНТЕРФЕЙСА === */
        
        let searchHistory = [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let currentLanguage = localStorage.getItem('language') || 'ru';

        // ФУНКЦИИ МОДАЛЬНЫХ ОКОН
        function closeAllModals() {
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
            // Закрываем также основной модал (описание достопримечательности)
            const mainModal = document.getElementById('modal');
            if (mainModal && mainModal.classList.contains('active')) {
                mainModal.classList.remove('active');
                document.getElementById('video-player').pause();
            }
        }

        // Закрытие модального окна при клике на оверлей
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // 🔍 ПОИСК
        function openSearch() {
            closeAllModals();
            document.getElementById('search-modal').classList.add('active');
            document.getElementById('search-input').value = '';
            document.getElementById('search-input').placeholder = t('modal.search_placeholder');
            
            // Показываем все места при открытии
            const results = document.getElementById('search-results');
            results.innerHTML = '';
            
            places.forEach(place => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                const imageUrl = (place.images && place.images[0]) ? place.images[0] : (place.image || 'https://via.placeholder.com/60?text=No+Image');
                div.innerHTML = `
                    <img src="${imageUrl}" alt="${place.name}" class="search-result-image" onerror="this.src='https://via.placeholder.com/60?text=No+Image'">
                    <div class="search-result-text">
                        <strong>${ getLocalizedPlaceField(place.id, 'name') || place.name }</strong><br><small>${ t('modal.coords') }: ${place.lat.toFixed(4)}, ${place.lng.toFixed(4)}</small>
                    </div>
                    <button class="search-result-btn">${ t('modal.search_go') }</button>
                `;
                div.onclick = (e) => {
                    if (e.target.classList.contains('search-result-btn') || e.target.parentElement.classList.contains('search-result-btn')) {
                        closeAllModals();
                        map.setView([place.lat, place.lng], 15);
                        openModal(place);
                        searchHistory.push({text: '', place: place.name, time: new Date()});
                    }
                };
                results.appendChild(div);
            });
        }

        document.getElementById('search-input').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const results = document.getElementById('search-results');
            results.innerHTML = '';

            // Функция для проверки названия на всех языках
            function matchesQuery(place) {
                if (!query) return true;
                
                // Проверяем основное название
                if (place.name.toLowerCase().includes(query)) return true;
                
                // Проверяем названия на всех языках (ru, kk, en)
                const languages = ['ru', 'kk', 'en'];
                for (let lang of languages) {
                    if (LOCALES[lang] && LOCALES[lang].places && LOCALES[lang].places[place.id]) {
                        const localizedName = LOCALES[lang].places[place.id].name;
                        if (localizedName && localizedName.toLowerCase().includes(query)) {
                            return true;
                        }
                    }
                }
                
                return false;
            }

            // Если поле пусто, показываем все места
            const filtered = query ? places.filter(matchesQuery) : places;
            
            if (filtered.length === 0) {
                results.innerHTML = `<p style="color: #999; text-align: center;">${t('modal.not_found')}</p>`;
                return;
            }

            filtered.forEach(place => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                const imageUrl = (place.images && place.images[0]) ? place.images[0] : (place.image || 'https://via.placeholder.com/60?text=No+Image');
                div.innerHTML = `
                    <img src="${imageUrl}" alt="${place.name}" class="search-result-image" onerror="this.src='https://via.placeholder.com/60?text=No+Image'">
                    <div class="search-result-text">
                        <strong>${ getLocalizedPlaceField(place.id, 'name') || place.name }</strong><br><small>${ t('modal.coords') }: ${place.lat.toFixed(4)}, ${place.lng.toFixed(4)}</small>
                    </div>
                    <button class="search-result-btn">${ t('modal.search_go') }</button>
                `;
                div.onclick = (e) => {
                    if (e.target.classList.contains('search-result-btn') || e.target.parentElement.classList.contains('search-result-btn')) {
                        closeAllModals();
                        map.setView([place.lat, place.lng], 15);
                        openModal(place);
                        searchHistory.push({text: query, place: place.name, time: new Date()});
                    }
                };
                results.appendChild(div);
            });
        });

        // 🌐 ЯЗЫК
        function openLanguage() {
            closeAllModals();
            document.getElementById('language-modal').classList.add('active');
        }

        function changeLanguage() {
            const lang = document.getElementById('language-select').value;
            localStorage.setItem('language', lang);
            currentLanguage = lang;
            applyLocaleToUI();

            // Also update visible modal texts if open
            const modal = document.getElementById('modal');
            if (modal.classList.contains('active') && currentPlace) {
                // update place title and chat welcome
                document.getElementById('place-title').innerText = getLocalizedPlaceField(currentPlace.id, 'name') || currentPlace.name;
                const chat = document.getElementById('chat-history');
                if (chat) chat.querySelector('.message.ai').innerText = t('modal.chat_welcome');
            }

            // update search modal
            const searchModal = document.getElementById('search-modal');
            if (searchModal) {
                searchModal.querySelector('h2').innerText = t('modal.search_title');
                document.getElementById('search-input').placeholder = t('modal.search_placeholder');
            }

            // update history/favorites headers
            const historyModal = document.getElementById('history-modal');
            if (historyModal) historyModal.querySelector('h2').innerText = t('modal.history_title');
            const favModal = document.getElementById('favorites-modal');
            if (favModal) favModal.querySelector('h2').innerText = t('modal.favorites_title');
            
            // update mapstyle modal header
            const mapstyleModal = document.getElementById('mapstyle-modal');
            if (mapstyleModal) mapstyleModal.querySelector('h2').innerText = t('modal.mapstyle_title');
            updateMapStyleUI();
        }

        // 🕑 ИСТОРИЯ
        function openHistory() {
            closeAllModals();
            const historyList = document.getElementById('history-list');
            
            if (searchHistory.length === 0) {
                historyList.innerHTML = `<p style="color: #999; text-align: center;">${t('modal.history_empty')}</p>`;
            } else {
                historyList.innerHTML = searchHistory.reverse().map((item, i) => `
                    <div style="padding: 10px; background: rgba(212, 165, 116, 0.1); border-radius: 8px; cursor: pointer;" onclick="findPlace('${item.place}')">
                        <strong>${item.text}</strong><br>
                        <small>📍 ${item.place}</small><br>
                        <small style="color: #999;">${item.time.toLocaleTimeString(currentLanguage === 'ru' ? 'ru-RU' : currentLanguage === 'kk' ? 'kk-KZ' : 'en-US')}</small>
                    </div>
                `).join('');
            }
            
            document.getElementById('history-modal').querySelector('h2').innerText = t('modal.history_title');
            document.getElementById('history-modal').classList.add('active');
        }

        function findPlace(placeName) {
            const place = places.find(p => p.name === placeName);
            if (place) {
                closeAllModals();
                map.setView([place.lat, place.lng], 15);
                openModal(place);
            }
        }

        // ⭐ ИЗБРАННОЕ
        function openFavorites() {
            closeAllModals();
            updateFavoritesList();
            document.getElementById('favorites-modal').querySelector('h2').innerText = t('modal.favorites_title');
            document.getElementById('favorites-modal').classList.add('active');
        }

        function updateFavoritesList() {
            const list = document.getElementById('favorites-list');
            
            if (favorites.length === 0) {
                list.innerHTML = `<p style="color: #999; text-align: center;">${t('modal.favorites_empty')}</p>`;
                return;
            }

            list.innerHTML = favorites.map((fav, idx) => `
                <div class="favorite-item">
                    <div>
                        <strong>${ getLocalizedPlaceField(fav.id, 'name') || fav.name }</strong><br>
                        <small style="color: #999;">📍 ${fav.lat.toFixed(4)}, ${fav.lng.toFixed(4)}</small>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="remove-favorite" onclick="removeFavorite(${idx})">✕</button>
                        <button class="remove-favorite" style="background: var(--primary-teal);" onclick="goToFavorite(${idx})">🗺️</button>
                    </div>
                </div>
            `).join('');
        }

        // Apply locale to UI (tooltips and current lang text)
        function applyLocaleToUI() {
            document.querySelector('.tool-btn.search').setAttribute('data-tooltip', t('tooltip.search'));
            document.querySelector('.tool-btn.language').setAttribute('data-tooltip', t('tooltip.language'));
            document.querySelector('.tool-btn.history').setAttribute('data-tooltip', t('tooltip.history'));
            document.querySelector('.tool-btn.favorites').setAttribute('data-tooltip', t('tooltip.favorites'));
                document.querySelector('.tool-btn.mapstyle').setAttribute('data-tooltip',
                    (currentLanguage === 'ru' ? 'Стиль' :
                     currentLanguage === 'kk' ? 'Стиль' :
                     currentLanguage === 'en' ? 'Style' : 'Стиль')
                );
            document.getElementById('language-select').value = currentLanguage;
            document.getElementById('current-lang').textContent = LOCALES[currentLanguage].ui.modal.language_current || currentLanguage;
            // ensure search modal titles
            document.getElementById('search-modal').querySelector('h2').innerText = t('modal.search_title');
            document.getElementById('search-modal').querySelector('#search-input').placeholder = t('modal.search_placeholder');
            // chat label
            const chatLabel = document.querySelector('.chat-label');
            if (chatLabel) chatLabel.innerText = '💬 ' + (t('ui.chat_label') || t('modal.chat_welcome').split('.')[0] || 'Спроси об этом месте');
            // default place title
            const placeTitle = document.getElementById('place-title');
            if (placeTitle && (!currentPlace || !document.getElementById('modal').classList.contains('active'))) {
                placeTitle.innerText = t('modal.loading');
            }
            // update language modal header
            const langModalHeader = document.getElementById('language-modal').querySelector('h2');
            if (langModalHeader) langModalHeader.innerText = '🌐 ' + (t('ui.language') || t('modal.language_current') || 'Language');
            const currentLangContainer = document.getElementById('current-lang-container');
            if (currentLangContainer) {
                currentLangContainer.innerHTML = (t('modal.current_language_label') || t('modal.language_current') || 'Текущий язык:') + ' <strong id="current-lang">' + (t('modal.language_current') || currentLanguage) + '</strong>';
            }
            // new: fill identified elements
            const searchTitleEl = document.getElementById('search-modal-title');
            if (searchTitleEl) searchTitleEl.innerText = t('modal.search_title');
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.placeholder = t('modal.search_placeholder');
            const langTitleEl = document.getElementById('language-modal-title');
            if (langTitleEl) langTitleEl.innerText = '🌐 ' + (t('ui.languages_title') || t('ui.language') || 'Language');
            // Update language option text
            const langOptRu = document.getElementById('lang-option-ru');
            const langOptKk = document.getElementById('lang-option-kk');
            const langOptEn = document.getElementById('lang-option-en');
            if (langOptRu) langOptRu.textContent = (t('ui.lang_ru') || 'Русский') + ' (РУ)';
            if (langOptKk) langOptKk.textContent = (t('ui.lang_kk') || 'Қазақша') + ' (KK)';
            if (langOptEn) langOptEn.textContent = (t('ui.lang_en') || 'English') + ' (EN)';
            const historyTitleEl = document.getElementById('history-modal-title');
            if (historyTitleEl) historyTitleEl.innerText = t('modal.history_title') || t('modal.history_title') || t('ui.history');
            const favTitleEl = document.getElementById('favorites-modal-title');
            if (favTitleEl) favTitleEl.innerText = t('modal.favorites_title') || t('ui.favorites');
            const historyEmpty = document.getElementById('history-empty');
            if (historyEmpty) historyEmpty.innerText = t('modal.history_empty');
            const favEmpty = document.getElementById('favorites-empty');
            if (favEmpty) favEmpty.innerText = t('modal.favorites_empty');
            const chatWelcome = document.getElementById('chat-welcome');
            if (chatWelcome) chatWelcome.innerText = t('modal.chat_welcome');
            const userInput = document.getElementById('user-input');
            if (userInput) userInput.placeholder = t('modal.chat_placeholder');
            // tooltips (already set above but ensure values exist)
            const toolSearch = document.querySelector('.tool-btn.search');
            if (toolSearch) toolSearch.setAttribute('data-tooltip', t('tooltip.search'));
            const toolLang = document.querySelector('.tool-btn.language');
            if (toolLang) toolLang.setAttribute('data-tooltip', t('tooltip.language'));
            const toolHist = document.querySelector('.tool-btn.history');
            if (toolHist) toolHist.setAttribute('data-tooltip', t('tooltip.history'));
            const toolFav = document.querySelector('.tool-btn.favorites');
            if (toolFav) toolFav.setAttribute('data-tooltip', t('tooltip.favorites'));
            // update favorites/history titles when modals open
        }

        // Initialize language from storage
        (function initLanguage() {
            currentLanguage = localStorage.getItem('language') || currentLanguage || 'ru';
            applyLocaleToUI();
        })();
            // update document title
            const docTitle = document.getElementById('doc-title');
            if (docTitle) docTitle.innerText = t('ui.app_title') || 'Гид по Таразу';
            document.title = docTitle ? docTitle.innerText : (t('ui.app_title') || 'Гид по Таразу');

        function addToFavorites(place) {
            const favObj = { id: place.id || null, name: place.name, lat: place.lat, lng: place.lng };
            if (!favorites.find(f => (f.id && favObj.id && f.id === favObj.id) || (!f.id && f.name === favObj.name))) {
                favorites.push(favObj);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                alert(`✅ "${ getLocalizedPlaceField(place.id, 'name') || place.name }" ${t('modal.added_fav')}`);
            }
        }

        function removeFavorite(idx) {
            favorites.splice(idx, 1);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoritesList();
        }

        function goToFavorite(idx) {
            const fav = favorites[idx];
            closeAllModals();
            map.setView([fav.lat, fav.lng], 15);
            openModal(fav);
        }

        /* === ФУНКЦИИ МАРШРУТИЗАЦИИ === */
        let routeControl = null;
        let routingActive = false;
        let selectingPoint = null;
        let mapClickListener = null;
        let currentTransportMode = 'car';
        let currentStartCoords = null;
        let currentEndCoords = null;
        let currentRoutes = [];
        let selectedRouteIndex = 0;

        // Обработчик для нажатия на маркер достопримечательности
        function handleMarkerClick(place, e) {
            // Если находимся в режиме выбора точки маршрута, используем достопримечательность
            if (selectingPoint) {
                // Предотвращаем распространение события на карту
                e.originalEvent.stopPropagation();
                
                // Используем координаты достопримечательности
                const latlng = L.latLng(place.lat, place.lng);
                
                // Устанавливаем точку с названием достопримечательности
                const inputId = selectingPoint + '-input';
                const input = document.getElementById(inputId);
                const button = document.getElementById(selectingPoint + '-map-btn');

                if (input) {
                    input.value = place.name;
                    input.dataset.lat = place.lat;
                    input.dataset.lng = place.lng;
                }

                if (button) {
                    button.classList.remove('active');
                    button.textContent = '🗺️';
                }

                showRoutingInfo(`✅ ${selectingPoint === 'start' ? 'Начало' : 'Конец'} выбран: ${place.name}`);

                // Добавляем маркер на карту для визуализации
                addSelectionMarker(latlng, selectingPoint);
                
                // Отменяем режим выбора
                cancelMapSelection();
            } else {
                // Если не в режиме выбора, открываем модал как обычно
                openModal(place);
            }
        }
        

        function toggleRoutingPanel() {
            const panel = document.getElementById('routing-control');
            routingActive = !routingActive;
            if (routingActive) {
                panel.classList.add('active');
                document.getElementById('start-input').focus();
                closeAllModals();
            } else {
                panel.classList.remove('active');
                closeRoutingPanel();
            }
        }

        function closeRoutingPanel() {
            const panel = document.getElementById('routing-control');
            panel.classList.remove('active');
            routingActive = false;
            clearRoute();
            cancelMapSelection();
        }

        function showRoutingInfo(message) {
            const info = document.getElementById('routing-info');
            info.textContent = message;
            info.classList.add('show');
            setTimeout(() => {
                info.classList.remove('show');
            }, 4000);
        }

        // === НОВЫЕ ФУНКЦИИ ДЛЯ ВЫБОРА ТОЧЕК НА КАРТЕ ===
        
        function selectPointOnMap(pointType) {
            console.log('Нажата кнопка выбора:', pointType);
            
            // Если уже выбираем эту точку - отмените
            if (selectingPoint === pointType) {
                cancelMapSelection();
                return;
            }

            // Отмените предыдущий выбор
            if (selectingPoint) {
                const oldBtn = document.getElementById(selectingPoint + '-map-btn');
                if (oldBtn) oldBtn.classList.remove('active');
            }

            selectingPoint = pointType;
            const button = document.getElementById(pointType + '-map-btn');
            if (button) {
                button.classList.add('active');
                button.textContent = '⏳';
            }

            showRoutingInfo(`📍 Нажмите на карту, чтобы выбрать ${pointType === 'start' ? 'начало маршрута' : 'конец маршрута'}`);

            // Переводим курсор в режим выбора
            document.getElementById('map').style.cursor = 'crosshair';

            // Удаляем старый слушатель, если есть
            if (mapClickListener) {
                map.off('click', mapClickListener);
            }

            // Создаем новый слушатель
            mapClickListener = function(e) {
                console.log('Клик по карте в координатах:', e.latlng);
                selectPointFromMap(pointType, e.latlng);
            };

            // Добавляем слушатель
            map.on('click', mapClickListener);
        }

        function selectPointFromMap(pointType, latlng) {
            console.log('Выбирается точка:', pointType, latlng);
            
            // Получаем название места по координатам
            getPlaceNameFromCoords(latlng).then(placeName => {
                console.log('Получено название места:', placeName);
                
                const inputId = pointType + '-input';
                const input = document.getElementById(inputId);
                const button = document.getElementById(pointType + '-map-btn');

                if (input) {
                    input.value = placeName;
                    input.dataset.lat = latlng.lat;
                    input.dataset.lng = latlng.lng;
                }

                if (button) {
                    button.classList.remove('active');
                    button.textContent = '🗺️';
                }

                showRoutingInfo(`✅ ${pointType === 'start' ? 'Начало' : 'Конец'} выбран: ${placeName}`);

                // Добавьте маркер на карту для визуализации
                addSelectionMarker(latlng, pointType);
                
                // Отмените режим выбора
                cancelMapSelection();
            }).catch(err => {
                console.error('Ошибка при получении названия места:', err);
                showRoutingInfo('❌ Ошибка при выборе места');
                cancelMapSelection();
            });
        }

        function cancelMapSelection() {
            console.log('Отмена выбора точки');
            
            if (mapClickListener) {
                map.off('click', mapClickListener);
                mapClickListener = null;
            }
            
            if (selectingPoint) {
                const button = document.getElementById(selectingPoint + '-map-btn');
                if (button) {
                    button.classList.remove('active');
                    button.textContent = '🗺️';
                }
                selectingPoint = null;
            }

            document.getElementById('map').style.cursor = 'grab';
        }

        function getPlaceNameFromCoords(latlng) {
            return new Promise((resolve, reject) => {
                try {
                    // Сначала проверяем наши места
                    for (let place of places) {
                        const placeLatLng = L.latLng(place.lat, place.lng);
                        const dist = latlng.distanceTo(placeLatLng);
                        console.log(`Расстояние до ${place.name}: ${dist}м`);
                        
                        // Если в пределах 500 метров
                        if (dist < 500) {
                            const name = getLocalizedPlaceField(place.id, 'name') || place.name;
                            console.log('Найдено в локальном списке:', name);
                            resolve(name);
                            return;
                        }
                    }

                    // Если не найдено в наших местах - ищем через Nominatim
                    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`;
                    console.log('Делаю запрос к Nominatim:', url);
                    
                    fetch(url)
                        .then(r => r.json())
                        .then(data => {
                            console.log('Ответ от Nominatim:', data);
                            
                            if (data && data.address) {
                                // Получаем улицу или название
                                const name = data.address.road || data.address.neighbourhood || data.address.suburb || 'Выбранная точка';
                                console.log('Найдено по адресу:', name);
                                resolve(name);
                            } else {
                                console.log('Некорректный ответ от Nominatim');
                                resolve('Выбранная точка');
                            }
                        })
                        .catch(err => {
                            console.error('Ошибка запроса к Nominatim:', err);
                            resolve('Выбранная точка');
                        });
                } catch (err) {
                    console.error('Ошибка в getPlaceNameFromCoords:', err);
                    reject(err);
                }
            });
        }

        // Глобальный объект для хранения маркеров выбора
        window.selectionMarkers = window.selectionMarkers || {};

        function addSelectionMarker(latlng, pointType) {
            // Удалите старый маркер этого типа, если есть
            if (window.selectionMarkers[pointType]) {
                try {
                    map.removeLayer(window.selectionMarkers[pointType]);
                } catch(e) {
                    console.error('Ошибка при удалении старого маркера:', e);
                }
            }

            // Создайте маркер с соответствующим цветом
            const markerColor = pointType === 'start' ? '🔴' : '🟡';
            const markerText = pointType === 'start' ? 'Начало маршрута' : 'Конец маршрута';
            
            try {
                const marker = L.circleMarker(latlng, {
                    radius: 10,
                    fillColor: pointType === 'start' ? '#e74c3c' : '#f39c12',
                    color: pointType === 'start' ? '#c0392b' : '#d68910',
                    weight: 3,
                    opacity: 0.8,
                    fillOpacity: 0.8,
                    title: markerText
                }).bindPopup(`<b>${markerText}</b>`).addTo(map);

                window.selectionMarkers[pointType] = marker;
                console.log('Маркер добавлен:', pointType);
            } catch(e) {
                console.error('Ошибка при добавлении маркера:', e);
            }
        }

        
    async function getCoordinates(query) {
        console.log("Ищу:", query); // Проверка в консоли
        if (!query) return null;

        // 1. Ищем в нашем списке (среди 10 мест)
        const localPlace = places.find(p => {
            // Безопасная проверка названий
            const n1 = (p.name || "").toLowerCase();
            const n2 = (getLocalizedPlaceField(p.id, 'name') || "").toLowerCase();
            const q = query.toLowerCase();
            return n1.includes(q) || n2.includes(q);
        });

        if (localPlace) {
            console.log("Найдено локально:", localPlace.name);
            return L.latLng(localPlace.lat, localPlace.lng);
        }

        // 2. Ищем в интернете (Nominatim)
        // Добавляем "Taraz" к поиску, чтобы не искать улицы в других городах
        const searchQuery = query.toLowerCase().includes("тараз") ? query : query + ", Тараз";
        
        return new Promise((resolve) => {
            // Используем прямой запрос к Nominatim (надежнее)
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        console.log("Найдено в интернете:", data[0]);
                        resolve(L.latLng(data[0].lat, data[0].lon));
                    } else {
                        console.log("Не найдено в интернете");
                        resolve(null);
                    }
                })
                .catch(err => {
                    console.error("Ошибка поиска:", err);
                    resolve(null);
                });
        });
    }

    // Функция создания маршрута
    async function createRoute() {
        console.log("Кнопка нажата!"); // Проверка, работает ли кнопка
        
        const startInput = document.getElementById('start-input');
        const endInput = document.getElementById('end-input');
        const startVal = startInput.value.trim();
        const endVal = endInput.value.trim();

        if (!startVal || !endVal) {
            showRoutingInfo('⚠️ Заполните оба поля');
            return;
        }

        showRoutingInfo('⏳ Поиск маршрута...');

        try {
            // Проверяем, выбрана ли точка на карте (есть dataset с координатами)
            let startCoords;
            if (startInput.dataset.lat && startInput.dataset.lng) {
                startCoords = L.latLng(parseFloat(startInput.dataset.lat), parseFloat(startInput.dataset.lng));
            } else {
                startCoords = await getCoordinates(startVal);
            }

            let endCoords;
            if (endInput.dataset.lat && endInput.dataset.lng) {
                endCoords = L.latLng(parseFloat(endInput.dataset.lat), parseFloat(endInput.dataset.lng));
            } else {
                endCoords = await getCoordinates(endVal);
            }

            if (!startCoords) {
                showRoutingInfo('❌ Не найдено место старта');
                return;
            }
            if (!endCoords) {
                showRoutingInfo('❌ Не найдено место финиша');
                return;
            }

            // Сохраняем текущие координаты
            currentStartCoords = startCoords;
            currentEndCoords = endCoords;

            // Удаляем старый маршрут
            if (window.routeControl) {
                map.removeControl(window.routeControl);
                window.routeControl = null;
            }

            // Получаем альтернативные маршруты и отображаем их
            await getAlternativeRoutes(startCoords, endCoords);

            // Рисуем маршрут для выбранного способа передвижения
            window.routeControl = L.Routing.control({
                waypoints: [startCoords, endCoords],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: currentTransportMode
                }),
                lineOptions: {
                    styles: [{ color: '#C75B39', opacity: 0.8, weight: 6 }]
                },
                createMarker: function(i, wp) {
                    return L.marker(wp.latLng, { draggable: true });
                },
                addWaypoints: false,
                show: false
            }).addTo(map);

            // Получаем времена в пути для всех способов передвижения
            await getTransportTimes(startCoords, endCoords);

            showRoutingInfo('✅ Маршрут построен! Выберите способ передвижения выше.');
            
            // Если мы на мобильном - скрываем панель, чтобы видеть карту
            if(window.innerWidth < 768) {
                document.getElementById('routing-control').classList.remove('active');
            }

        } catch (e) {
            console.error("Ошибка маршрута:", e);
            showRoutingInfo('❌ Ошибка программы');
        }
    }

    // Очистка маршрута
    function clearRoute() {
        if (window.routeControl) {
            map.removeControl(window.routeControl);
            window.routeControl = null;
        }
        const sInput = document.getElementById('start-input');
        sInput.value = '';
        delete sInput.dataset.lat;
        delete sInput.dataset.lng;
        const eInput = document.getElementById('end-input');
        eInput.value = '';
        delete eInput.dataset.lat;
        delete eInput.dataset.lng;
        document.getElementById('routing-info').classList.remove('show');
        document.getElementById('routing-time-container').classList.remove('show');
        document.getElementById('routes-container').classList.remove('show');

        // Удаляем маркеры
        if (window.selectionMarkers.start) {
            map.removeLayer(window.selectionMarkers.start);
            delete window.selectionMarkers.start;
        }
        if (window.selectionMarkers.end) {
            map.removeLayer(window.selectionMarkers.end);
            delete window.selectionMarkers.end;
        }

        // Удаляем дополнительные маршруты
        if (window.routeLayers) {
            window.routeLayers.forEach(layer => {
                try {
                    map.removeLayer(layer);
                } catch(e) {}
            });
            window.routeLayers = [];
        }
    }

    // === НОВЫЕ ФУНКЦИИ ДЛЯ СПОСОБОВ ПЕРЕДВИЖЕНИЯ И ВРЕМЕНИ === 

    // Выбор способа передвижения
    // При выборе нового способа обновляется маршрут и показывает информацию только для выбранного транспорта
    function selectTransportMode(mode) {
        currentTransportMode = mode;
        
        // Обновляем UI кнопок - подсвечиваем выбранный способ
        document.querySelectorAll('.transport-mode-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`.transport-mode-btn[data-mode="${mode}"]`).classList.add('active');

        // Если уже есть начало и конец маршрута - пересчитываем для выбранного способа
        if (currentStartCoords && currentEndCoords) {
            updateRouteForTransportMode();
            // Показываем информацию только для выбранного способа передвижения
            displayTransportModeInfo(mode);
        }
    }

    // Показать информацию только для выбранного способа передвижения
    function displayTransportModeInfo(mode) {
        const container = document.getElementById('time-rows-container');
        container.innerHTML = '';
        
        const modeNames = {
            'car': '🚗 На машине',
            'foot': '🚶 Пешком',
            'bike': '🚴 На велосипеде',
            'bus': '🚌 На автобусе'
        };

        // Получаем сохраненную информацию о времени для этого способа
        if (window.transportTimesCache && window.transportTimesCache[mode]) {
            const timeInfo = window.transportTimesCache[mode];
            
            const row = document.createElement('div');
            row.className = 'time-row single-mode';
            
            row.innerHTML = `
                <span class="time-mode">${modeNames[mode]}</span>
                <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                    <span><span class="time-value">${timeInfo.duration}</span></span>
                    <span style="font-size: 11px; color: #666;">📏 ${timeInfo.distance}</span>
                </div>
            `;
            container.appendChild(row);
        }
    }

    // Обновление маршрута для выбранного способа передвижения
    // Функция перестраивает маршрут и показывает новое время в пути
    async function updateRouteForTransportMode() {
        try {
            showRoutingInfo('⏳ Обновление маршрута...');

            // Удаляем старый маршрут с карты
            if (window.routeControl) {
                map.removeControl(window.routeControl);
                window.routeControl = null;
            }

            // Рисуем новый маршрут для выбранного способа передвижения
            // OSRM автоматически выбирает оптимальный путь для каждого транспорта
            window.routeControl = L.Routing.control({
                waypoints: [currentStartCoords, currentEndCoords],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: currentTransportMode
                }),
                lineOptions: {
                    styles: [{ color: '#C75B39', opacity: 0.8, weight: 6 }]
                },
                createMarker: function(i, wp) {
                    return L.marker(wp.latLng, { draggable: false });
                },
                addWaypoints: false,
                show: false
            }).addTo(map);

            // Получаем обновленные времена в пути для всех способов передвижения
            // Это показывает пользователю, как изменилось время при выборе другого транспорта
            await getTransportTimes(currentStartCoords, currentEndCoords);
            
            // Показываем информацию только для выбранного способа передвижения
            displayTransportModeInfo(currentTransportMode);

            showRoutingInfo('✅ Маршрут обновлен для выбранного способа передвижения!');
        } catch (e) {
            console.error("Ошибка обновления маршрута:", e);
            showRoutingInfo('❌ Ошибка обновления маршрута');
        }
    }

    // Получение времени в пути для всех способов передвижения
    async function getTransportTimes(startCoords, endCoords) {
        const modes = ['car', 'foot', 'bike', 'bus'];
        const modeNames = {
            'car': '🚗 На машине',
            'foot': '🚶 Пешком',
            'bike': '🚴 На велосипеде',
            'bus': '🚌 На автобусе'
        };
        
        // Профили OSRM для каждого способа передвижения
        // Каждый профиль учитывает особенности маршрутизации для конкретного транспорта
        const modeOsrm = {
            'car': 'car',      // маршруты для автомобилей (дороги, скоро сти)
            'foot': 'foot',    // маршруты для пешеходов (тротуары, пешеходные зоны)
            'bike': 'bike',    // маршруты для велосипедов (велодорожки, безопасные дороги)
            'bus': 'car'       // автобусы ездят по тем же дорогам, что и машины
        };
        
        // Коэффициенты умножения для более точного расчета времени в пути
        // Учитываем дополнительные факторы (остановки, ожидания, правила дорожного движения и т.д.)
        const timeMultipliers = {
            'car': 1.15,       // +15% на светофоры и пробки в городе
            'foot': 1.1,       // +10% на подъемы и неудобства
            'bike': 1.05,      // +5% на неровности дороги
            'bus': 1.4         // +40% на остановки, ожидание пассажиров и светофоры
        };
        
        // Средние скорости для каждого способа передвижения в городе (км/ч)
        // Эти значения являются ориентировочными и основаны на реальных данных
        const avgSpeeds = {
            'car': 35,         // в городе Таразе (учитывая пробки и светофоры)
            'foot': 5,         // скорость пешехода (не торопясь)
            'bike': 18,        // скорость велосипедиста в городе
            'bus': 22          // скорость автобуса (с учетом остановок)
        };

        const times = {};
        
        // Инициализируем кэш для сохранения информации о времени
        if (!window.transportTimesCache) {
            window.transportTimesCache = {};
        }
        
        for (let mode of modes) {
            try {
                // Запрашиваем маршрут через OSRM API с правильным профилем
                const osrmProfile = modeOsrm[mode];
                const url = `https://router.project-osrm.org/route/v1/${osrmProfile}/${startCoords.lng},${startCoords.lat};${endCoords.lng},${endCoords.lat}?overview=false&steps=false`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.routes && data.routes[0]) {
                    let durationSeconds = data.routes[0].duration;
                    const distance = data.routes[0].distance;
                    
                    // Применяем коэффициент умножения для более реалистичного расчета
                    // Это учитывает特специфику каждого способа передвижения
                    durationSeconds = durationSeconds * timeMultipliers[mode];
                    
                    // Преобразуем секунды в минуты и часы
                    const minutes = Math.round(durationSeconds / 60);
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    
                    // Форматируем время для отображения
                    let timeStr;
                    if (hours > 0) {
                        timeStr = `${hours}ч ${mins}м`;
                    } else {
                        timeStr = `${mins}м`;
                    }
                    
                    // Также рассчитываем примерное время на основе средней скорости
                    // Это дополнительная проверка точности
                    const distanceKm = distance / 1000;
                    const estimatedMinutes = Math.round((distanceKm / avgSpeeds[mode]) * 60);
                    const estimatedHours = Math.floor(estimatedMinutes / 60);
                    const estimatedMins = estimatedMinutes % 60;
                    
                    let estimatedTimeStr;
                    if (estimatedHours > 0) {
                        estimatedTimeStr = `${estimatedHours}ч ${estimatedMins}м`;
                    } else {
                        estimatedTimeStr = `${estimatedMins}м`;
                    }
                    
                    // Сохраняем все данные маршрута
                    times[mode] = {
                        duration: timeStr,                    // время по OSRM с коэффициентом
                        estimatedDuration: estimatedTimeStr,  // ориентировочное время по скорости
                        distance: distanceKm.toFixed(1) + ' км',
                        minutes: minutes,
                        avgSpeed: avgSpeeds[mode],
                        distanceMeters: distance,
                        profile: osrmProfile
                    };
                    
                    // Сохраняем в кэш для быстрого доступа
                    window.transportTimesCache[mode] = times[mode];
                } else {
                    times[mode] = { duration: 'Не найдено', distance: '—', minutes: 0 };
                    window.transportTimesCache[mode] = times[mode];
                }
            } catch(e) {
                console.error(`Ошибка получения времени для ${mode}:`, e);
                times[mode] = { duration: 'Ошибка', distance: '—', minutes: 0 };
                window.transportTimesCache[mode] = times[mode];
            }
        }

        // Отображаем все способы передвижения при первом поиске
        // А затем пользователь может нажать на кнопку для показа только одного способа
        displayAllTransportModes(times, modeNames);

        return times;
    }

    // Показать все способы передвижения в отсортированном виде
    function displayAllTransportModes(times, modeNames) {
        const container = document.getElementById('time-rows-container');
        container.innerHTML = '';
        
        const modes = ['car', 'foot', 'bike', 'bus'];
        
        // Сортируем по времени путешествия (быстрее всего - первое)
        const sortedModes = modes.sort((a, b) => {
            return (times[a].minutes || Infinity) - (times[b].minutes || Infinity);
        });
        
        sortedModes.forEach((mode, index) => {
            const row = document.createElement('div');
            row.className = 'time-row';
            
            // Показываем рекомендацию для самого быстрого способа
            const isFastest = index === 0 ? ' ⭐ (Быстрее)' : '';
            
            row.innerHTML = `
                <span class="time-mode">${modeNames[mode]}${isFastest}</span>
                <span><span class="time-value">${times[mode].duration}</span> (${times[mode].distance})</span>
            `;
            container.appendChild(row);
        });

        document.getElementById('routing-time-container').classList.add('show');
    }

    // Получение альтернативных маршрутов
    async function getAlternativeRoutes(startCoords, endCoords) {
        try {
            // OSRM поддерживает параметр alternatives для получения альтернативных маршрутов
            const url = `https://router.project-osrm.org/route/v1/${currentTransportMode}/${startCoords.lng},${startCoords.lat};${endCoords.lng},${endCoords.lat}?alternatives=true&overview=full&geometries=geojson`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.routes && data.routes.length > 0) {
                currentRoutes = data.routes;
                displayAlternativeRoutes();
                return data.routes;
            }
        } catch(e) {
            console.error('Ошибка получения альтернативных маршрутов:', e);
        }
        return [];
    }

    // Отображение альтернативных маршрутов
    function displayAlternativeRoutes() {
        if (currentRoutes.length <= 1) {
            document.getElementById('routes-container').classList.remove('show');
            return;
        }

        const routesList = document.getElementById('routes-list');
        routesList.innerHTML = '';

        currentRoutes.forEach((route, index) => {
            const duration = Math.round(route.duration / 60);
            const distance = (route.distance / 1000).toFixed(1);
            const hours = Math.floor(duration / 60);
            const mins = duration % 60;
            
            let timeStr;
            if (hours > 0) {
                timeStr = `${hours}ч ${mins}м`;
            } else {
                timeStr = `${mins}м`;
            }

            const option = document.createElement('div');
            option.className = 'route-option' + (index === selectedRouteIndex ? ' selected' : '');
            option.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    <span>${index === 0 ? '⭐ Оптимальный' : `🛣️ Маршрут ${index + 1}`}</span>
                    <span>${timeStr} • ${distance} км</span>
                </div>
            `;
            option.onclick = () => selectAlternativeRoute(index);
            routesList.appendChild(option);
        });

        document.getElementById('routes-container').classList.add('show');
    }

    // Выбор альтернативного маршрута
    function selectAlternativeRoute(index) {
        selectedRouteIndex = index;
        const route = currentRoutes[index];

        // Обновляем UI
        document.querySelectorAll('.route-option').forEach((el, i) => {
            el.classList.toggle('selected', i === index);
        });

        // Удаляем старый маршрут
        if (window.routeControl) {
            map.removeControl(window.routeControl);
            window.routeControl = null;
        }

        // Удаляем предыдущие эти дополнительные маршруты
        if (window.routeLayers) {
            window.routeLayers.forEach(layer => {
                try {
                    map.removeLayer(layer);
                } catch(e) {}
            });
        }
        window.routeLayers = [];

        // Рисуем выбранный маршрут
        if (route.geometry && route.geometry.coordinates) {
            const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
            
            window.routeControl = L.Routing.control({
                waypoints: [currentStartCoords, currentEndCoords],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                lineOptions: {
                    styles: [{ color: '#FFB366', opacity: 0.8, weight: 6 }]
                },
                createMarker: function(i, wp) {
                    return L.marker(wp.latLng, { draggable: false });
                },
                addWaypoints: false,
                show: false
            }).addTo(map);
        }
    }

    // Отображение всех альтернативных маршрутов на карте
    function displayMultipleRoutes() {
        window.routeLayers = window.routeLayers || [];

        // Удаляем старые слои
        window.routeLayers.forEach(layer => {
            try {
                map.removeLayer(layer);
            } catch(e) {}
        });
        window.routeLayers = [];

        // Цвета для разных маршрутов
        const colors = ['#C75B39', '#4A9B9F', '#D4A574', '#52B788'];

        // Рисуем каждый маршрут
        currentRoutes.forEach((route, index) => {
            if (route.geometry && route.geometry.coordinates) {
                const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
                const polyline = L.polyline(coords, {
                    color: colors[index % colors.length],
                    opacity: index === selectedRouteIndex ? 1 : 0.4,
                    weight: index === selectedRouteIndex ? 6 : 3,
                    dashArray: index === 0 ? '' : '5, 5'
                }).addTo(map);
                window.routeLayers.push(polyline);
            }
        });

        // Центрируем карту на маршруте
        if (window.routeLayers.length > 0) {
            const group = new L.FeatureGroup(window.routeLayers);
            map.fitBounds(group.getBounds(), { padding: [50, 50] });
        }
    }
    
    // --- КОНЕЦ ВСТАВКИ ---
    // --- ЛОГИКА ГЛОБАЛЬНОГО ИИ-ЧАТА ---

// --- ИСПРАВЛЕННАЯ ЛОГИКА ОТКРЫТИЯ/ЗАКРЫТИЯ ---

    function toggleGlobalChat() {
        const modal = document.getElementById('global-ai-modal');
        
        // 1. Запоминаем, было ли окно открыто ПЕРЕД тем, как мы начнем что-то менять
        const isAlreadyOpen = modal.classList.contains('active');

        // 2. Закрываем вообще всё (чтобы убрать другие окна, если они есть)
        if (typeof closeAllModals === 'function') {
            closeAllModals(); 
        }

        // 3. Если окно БЫЛО закрыто — открываем его.
        // Если оно БЫЛО открыто — мы его уже закрыли шагом 2, поэтому ничего делать не надо.
        if (!isAlreadyOpen) {
            modal.classList.add('active');
            
            // Фокус на поле ввода
            setTimeout(() => {
                const input = document.getElementById('global-user-input');
                if(input) input.focus();
            }, 300);
        }
        
        // Скрываем подсказку когда открывают чат
        hideAIHint();
    }

    // Подсказка для ИИ кнопки
    let aiHintInterval = null;
    const aiHintMessages = [
        '💬 Спросите ИИ',
        '🤖 Используйте чат',
        '✨ Задайте вопрос',
        '💡 Получите совет'
    ];

    function showAIHint() {
        const hintEl = document.getElementById('ai-hint');
        if (!hintEl || document.getElementById('global-ai-modal').classList.contains('active')) return;
        
        const randomMsg = aiHintMessages[Math.floor(Math.random() * aiHintMessages.length)];
        hintEl.textContent = randomMsg;
        hintEl.classList.add('show');
        
        // Скрыть подсказку через 4 секунды
        setTimeout(() => {
            hintEl.classList.remove('show');
        }, 4000);
    }

    function hideAIHint() {
        const hintEl = document.getElementById('ai-hint');
        if (hintEl) hintEl.classList.remove('show');
    }

    // Запуск подсказки время от времени (каждые 45-70 секунд)
    function startAIHintLoop() {
        clearInterval(aiHintInterval);
        const randomDelay = Math.random() * 25000 + 45000; // 45-70 секунд
        aiHintInterval = setInterval(() => {
            // Показываем только если чат не открыт
            if (!document.getElementById('global-ai-modal').classList.contains('active')) {
                showAIHint();
            }
            // Повторяем каждые 45-70 секунд
            clearInterval(aiHintInterval);
            startAIHintLoop();
        }, randomDelay);
    }

    // Запасной вариант: показать подсказку первый раз через 30 сек
    function initAIHint() {
        setTimeout(() => {
            startAIHintLoop();
        }, 30000); // Первая подсказка через 30 секунд
    }

    // Инициализация при загрузке
    setTimeout(initAIHint, 1000);

    // Обновленная функция закрытия всего, чтобы она точно знала про новый чат
    function closeAllModals() {
        // Закрываем все оверлеи
        document.querySelectorAll('.modal-overlay.active').forEach(el => el.classList.remove('active'));
        
        // Закрываем обычный модал места
        const placeModal = document.getElementById('modal');
        if (placeModal) {
            placeModal.classList.remove('active');
            const video = document.getElementById('video-player');
            if(video) video.pause();
        }

        // Закрываем 3D модель
        const container3D = document.getElementById('model-3d-container');
        if (container3D) container3D.classList.remove('active');

        // Закрываем Глобальный чат (ОБЯЗАТЕЛЬНО)
        const globalModal = document.getElementById('global-ai-modal');
        if (globalModal) globalModal.classList.remove('active');
        
        // Закрываем панель маршрутов (если нужно, раскомментируйте)
        // const routingPanel = document.getElementById('routing-control');
        // if (routingPanel) routingPanel.classList.remove('active');
    }
        // Фокус на поле ввода, если открыли
        if (modal.classList.contains('active')) {
            setTimeout(() => {
                const input = document.getElementById('global-user-input');
                if(input) input.focus();
            }, 300);
        }


    // 2. Добавление сообщения в историю чата
    function addGlobalMessage(text, type) {
        const history = document.getElementById('global-chat-history');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerText = text;
        history.appendChild(div);
        history.scrollTop = history.scrollHeight; // Прокрутка вниз
        return div;
    }

    // 3. Отправка сообщения в n8n
    async function sendGlobalMessage() {
        const input = document.getElementById('global-user-input');
        const text = input.value.trim();
        
        if (!text) return;

        // Показываем сообщение пользователя
        addGlobalMessage(text, 'user');
        input.value = '';

        // Показываем индикатор загрузки
        const loadingMsg = addGlobalMessage('Думаю...', 'loading');

        try {
            // Подготавливаем данные для отправки в N8N
            const payload = {
                question: text,
                context_place: currentPlace ? (getLocalizedPlaceField(currentPlace.id, 'name') || currentPlace.name) : 'General Guide',
                user_id: tg.initDataUnsafe?.user?.id || ("guest_" + Math.random().toString(36).substr(2, 9)),
                language: currentLanguage,
                chat_type: 'global',
                timestamp: new Date().toISOString()
            };

            console.log('Отправляем глобальное сообщение в N8N:', payload); // Для отладки

            // Используем вашу переменную N8N_WEBHOOK_URL
            const response = await fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            // Проверяем статус ответа перед парсингом JSON
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            // Удаляем "Думаю..." и показываем ответ
            if (loadingMsg && loadingMsg.parentNode) {
                loadingMsg.remove();
            }
            
            if (data.answer) {
                addGlobalMessage(data.answer, 'ai');
            } else if (data.error) {
                addGlobalMessage(`❌ Ошибка: ${data.error}`, 'ai');
            } else {
                addGlobalMessage("Извини, я не смог получить ответ.", 'ai');
            }

        } catch (error) {
            console.error('Ошибка глобального N8N чата:', error);
            if (loadingMsg && loadingMsg.parentNode) {
                loadingMsg.remove();
            }
            addGlobalMessage(`❌ Ошибка: ${error.message}`, 'ai');
        }
    }

    // Обработка нажатия Enter в поле ввода
    document.getElementById('global-user-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendGlobalMessage();
    });

    // Обработка нажатия Escape для закрытия модальных окон
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            const arModal = document.getElementById('ar-modal');
            const qrModal = document.getElementById('qr-modal');
            
            if (arModal && arModal.style.display === 'flex') {
                closeARModal();
            } else if (qrModal && qrModal.style.display === 'flex') {
                closeQRModal();
            }
        }
    });

    </script>
</body>

</html>
